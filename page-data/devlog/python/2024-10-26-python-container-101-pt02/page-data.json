{"componentChunkName":"component---src-templates-post-template-post-template-tsx","path":"/devlog/python/2024-10-26-python-container-101-pt02","result":{"data":{"markdownRemark":{"id":"061a9359-0ab1-54c0-b908-d915a6174d59","html":"<p>이번 게시글에서는 컨테이너 크기를 줄이기 위한 방안을 살펴보고, 파이썬 컨테이너 이미지 빌드가 가지는 특징을 살펴보도록 하겠습니다.</p>\n<h2 id=\"빌드-최적화를-해봅시다\" style=\"position:relative;\"><a href=\"#%EB%B9%8C%EB%93%9C-%EC%B5%9C%EC%A0%81%ED%99%94%EB%A5%BC-%ED%95%B4%EB%B4%85%EC%8B%9C%EB%8B%A4\" aria-label=\"빌드 최적화를 해봅시다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>빌드 최적화를 해봅시다</h2>\n<p>지난 글에서 빌드된 이미지의 크기를 다시 살펴볼까요?</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">docker</span> images python-hello\nREPOSITORY     TAG       IMAGE ID       CREATED         SIZE\npython-hello   latest    746136719e90   <span class=\"token number\">3</span> minutes ago   <span class=\"token number\">1</span>.46GB</code></pre></div>\n<p>1.46GB인 데는 분명 이유가 있을 겁니다. 그러면 <code class=\"language-text\">latest</code> 라는 태그가 무엇을 의미하는지부터 살펴볼까요?</p>\n<h3 id=\"잠시만-왜-이렇게-크지\" style=\"position:relative;\"><a href=\"#%EC%9E%A0%EC%8B%9C%EB%A7%8C-%EC%99%9C-%EC%9D%B4%EB%A0%87%EA%B2%8C-%ED%81%AC%EC%A7%80\" aria-label=\"잠시만 왜 이렇게 크지 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>잠시만, 왜 이렇게 크지?</h3>\n<p><a href=\"https://hub.docker.com/_/python\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Docker Hub</a>으로 다시 들어가봐서, 어떤 컨테이너가 있나 살펴봅시다.</p>\n<p>뭔가 되게 많군요. 숫자는 파이썬 버전같은데, <code class=\"language-text\">-</code> 뒤의 값은 뭔지 알아봅시다.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 466px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/13c8ea80289a195a226aad717c67eb86/fc1a1/01-python-container-simple.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 143.33333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAdCAYAAACqhkzFAAAACXBIWXMAABYlAAAWJQFJUiTwAAAE6ElEQVRIx41WW3ubSAz1626TmPttYIABDNgYMI5vceMm6SZpsl///885uxKO225f9kEeNBfNkXSk8WR/POHb+3d8eXrG0/M3/j49fMWXpxfs7k7YHj7j4esLz//1+o7X9+9o+ltcGy40O/hNJot+zQcOnx/Q9Gusd3fYHU+gi+gwSbno0A5bzNsB1XIFEee4MX02MD0bmlo+y8QRCcK0QFJUELGCF8aQagYniLDZHXB6eIJmufjjWsenqclyYzjQbQ+adRbb/4GwqOaw1Rqf5B7XcgNNHaGpO+jqDldygz/FGkZxgpntYdJYnGBkB+jJBkZ2hJ4d4aQdDGdEOUnyEsmsRVj0iMsBZjiD5ufQg4LFEAU0nyTj+Yt42WXU3fji9qS/3eH59Q3dsMHLtzcEMsWVbrMrU9P9f0J7LZ9dn1wZLq50Bzemy5kzHAHTDaE7AroTXHTDFYyCvk0v5DX9spfiJzhBE5q0ggROXCHIlohmHcK8heaEsMICYdEhqQd46Rw3loDIGshqBTepYQYp4nrN54ywxtQWmNCttkjh5z1EMSCsNpD1FqrZQ+QdzKiEnw+IqlvIao14sUdQrGAEGWS9gavGyz88mJCrgVqg3PyFaH6ElzZImgOy7h5Ze4Qbz+EkC0TVFklzx0Zpj5d1rNuyhKcaiHw5uqxZPkw/QThbwYpqGG7EcmMF7ILB8QuhuyGm1hi3UY84buN6BM2NzzGkQHsRzLCArxZsWBQdNFfCikoEeQdZDewFzX3oXlLDEhkjDrIGuqj4ggml2o1ogWK0QbLYIWvvUHRHyFkPW1YQ5ZbX43pcJ87qXsqxDrL2XIbn0puaHryk4gATCro1KteIygFxtWaDTOCfyuuDxBfd+lHX7DLRhm6KqwF5u2MkMVEjrtgltdggXWyRLjbw0xqypH17qGaHMG9AoC61TFm2hMJ8/wrVP8DLb2H4Kdx0eY7XGnZUwhQFPNWe9RnHlzzxVfMLWs4yZclPSthhDjPIYHkhDC/iDZRFy49hBTEnTzsn8UOn7P/SDyk2TphBdSdkqwfmn5jfM7+IvG7aIJwR6Xv+NgMFXy0RlStGbIqcXb70Q/ohbrlyBiea8Wj4im/TnfA8CthBckkGob/w0Rm9+UDKLgeqRjE8olw/Qs73aA5vWBzeUG6fka0ekQ9PqLYvyPt7qOURYb1Dc3xHc/wb5eYZxfDE8dddOSbFiefI+gfm2LVbQHMTTozuJSxcBY7k+NL8teH9tDau6376gzb0DARpDaHmSMoWSbmESEsWLy5Y9+MCpi8hVMW6LBaXPUEyw80504yQSi5a3MFOW8TtCdnwxGPUfIaoD5DLE8RsgJv1yG+fkfaPkMt7RM0oSXeCEc4/Si9gWjhRDk8WkMUSUd5wkCn79J2UHdNq6mW4MVx+pKhLE5ixMTsXLrJB04/hpi2cpGEkYrZmUpNuyTn3Q+qBnlpyeRITqNsQwe2o4NKlbDNtiIeEMJoN3H3HptkhUHNuvOxBoNgDQkl9jzqN7sVwZMlGqRx/MUgI7aTh7utnLbd36iBEYqpnOkAGr+0YV5qNa93mx4lc/81l/RxDgu3FFaKihSx7ePEMblwymvGdWcKRNZxQ8X7NS3/7G3JGOMbQjhewZA0/6+DnHcJyzQaJaxRLX7UQec/z9CjxW/3fNvYvwn8A+TEY7RVYJ8oAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/13c8ea80289a195a226aad717c67eb86/8ac56/01-python-container-simple.webp 240w,\n/static/13c8ea80289a195a226aad717c67eb86/fbab0/01-python-container-simple.webp 466w\"\n              sizes=\"(max-width: 466px) 100vw, 466px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/13c8ea80289a195a226aad717c67eb86/8ff5a/01-python-container-simple.png 240w,\n/static/13c8ea80289a195a226aad717c67eb86/fc1a1/01-python-container-simple.png 466w\"\n            sizes=\"(max-width: 466px) 100vw, 466px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/13c8ea80289a195a226aad717c67eb86/fc1a1/01-python-container-simple.png\"\n            alt=\"Figure 1. 어떤 파이썬 컨테이너가 있나 살펴봅시다 (simple tags)\"\n            title=\"Figure 1. 어떤 파이썬 컨테이너가 있나 살펴봅시다 (simple tags)\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\"><p>Figure 1. 어떤 파이썬 컨테이너가 있나 살펴봅시다 (simple tags)</p></figcaption>\n  </figure></p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c7fe6111e7706fe4a29ae1f54cdd0e5c/fcda8/02-python-container-shared.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 107.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAABYlAAAWJQFJUiTwAAAC1klEQVQ4y41V7XKjOBD0CySAQehbCIHAENvx5urux27tVu29/zv1lQZw7MS5ux9TIwk0zHRPD7vvP3/jx6/f+Ov7T/z49TcqaZFVEjlTn+yr81vbNd0BbZxgfMQwn1HUmi5u9lyK6/r/BN097Tld2nONp6LGvta0LphCKQy48SjqD5km/0XgXcqoFBa19qhUi9oEcNuTZ6YDt92ambrLPGPqLvNrwHSQMihlA94coLsTbHyFi2dU9oC8dijY8g5lXmvkTH+d4TWgcKhMBHcjpJ+gwgtkO0H6GcLP4M0EN15onYkOeSUeErYG1KiUh/Av0P0r3OEP+OlPmOEb7WU4wY1vEN0rMh4oWLbBcBMs+d2Cg3gHuzZkBbdU2nJJX/dLRvLdPrBPpEgX4LoRrhvQDjPCMEO5gKYf4cIAYTyM7+DjRO+ppoN0HYQN1Al7bu5L5qaF9hGq6Sm49j1q3dBFG9YANsD4Hkw1yGv7mZDbgGmTSqrMCO5fCDMTLxDtEXWTCFksnaV9JgLB9LF1rhgSKdQ2M1Rqm+GC5vAGE1+h+zNke4Qbv0G0Jzxzj7zid1ndYbgdJByST8EX+al3WxndCPlPpVTSEWapcZNnukFBbOsbZh9L71+U4lC7EcJPVKrtTyjtAVltkZX1glnJlxa7kd5jpaSSV6UwEymobGeSIm9G8uljNp7A/XSnlA2Ku7ZJ+DHlwd0A6Q/w4wVhfoMbzjD9ETrMcMMJOl5QqH6F4vGc3G20J8z2qkMuAvaqR6kj+W1dmQG5aPFUKjztaxp526zMb9pnJcWCSYtKGGhq4pb2XDuUNBsFmDQQ1i/PXUsqEbb9NCt3W8sw5cBtgPIDmniEH46w3QTdjpBNJAuHM0w3ozSRJJfm6MOS85UU5iZUbgL3R2pi1ryAuZlMhBN4e0ahIjJmkD34NdwpZZuHzA7Q3REmnteZOBPrac3siGdmH8zC95L/ATI2OhhUfcsaAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/c7fe6111e7706fe4a29ae1f54cdd0e5c/8ac56/02-python-container-shared.webp 240w,\n/static/c7fe6111e7706fe4a29ae1f54cdd0e5c/d3be9/02-python-container-shared.webp 480w,\n/static/c7fe6111e7706fe4a29ae1f54cdd0e5c/5ca24/02-python-container-shared.webp 590w\"\n              sizes=\"(max-width: 590px) 100vw, 590px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/c7fe6111e7706fe4a29ae1f54cdd0e5c/8ff5a/02-python-container-shared.png 240w,\n/static/c7fe6111e7706fe4a29ae1f54cdd0e5c/e85cb/02-python-container-shared.png 480w,\n/static/c7fe6111e7706fe4a29ae1f54cdd0e5c/fcda8/02-python-container-shared.png 590w\"\n            sizes=\"(max-width: 590px) 100vw, 590px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/c7fe6111e7706fe4a29ae1f54cdd0e5c/fcda8/02-python-container-shared.png\"\n            alt=\"Figure 2. 어떤 파이썬 컨테이너가 있나 살펴봅시다 (shared tags)\"\n            title=\"Figure 2. 어떤 파이썬 컨테이너가 있나 살펴봅시다 (shared tags)\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\"><p>Figure 2. 어떤 파이썬 컨테이너가 있나 살펴봅시다 (shared tags)</p></figcaption>\n  </figure></p>\n<p>이 값들은 각각 Simple tags, Shared tags 인데요. 이 값은 아래와 같습니다.</p>\n<ul>\n<li>\n<p><code class=\"language-text\">simple tags</code>: 태그로 기재된 리눅스 배포판 혹은 윈도우즈에서만 동작을 보장하는 컨테이너 이미지 입니다. 이 값을 사용하면 해당 태그에 명시된 플랫폼(리눅스나 윈도우즈 등)의 하나의 이미지 정보(이미지의 구성 정보, 레이어 정보, 실행 환경 등을 담은 매니페스트)에 연결됩니다. 이 경우, 명확히 지정한 플랫폼의 이미지만 사용할 수 있습니다.</p>\n</li>\n<li>\n<p><code class=\"language-text\">shared tags</code>: 여러 운영체제(리눅스 및 다양한 윈도우즈 버전)와 아키텍처에서 동작하는 컨테이너 이미지를 나타냅니다. 이 값을 Docker Engine이 구동되는 환경(운영체제, 아키텍처 등)에 맞는 적절한 이미지를 자동으로 선택해서 pull하게 됩니다. 예를 들어, mongo:4.0 같은 shared tag를 사용하면 Docker Engine이 현재 실행 중인 호스트의 운영체제와 아키텍처에 맞는 이미지를 알아서 가져옵니다.</p>\n</li>\n</ul>\n<details>\n<summary>🤔 도커의 매니페스트란?</summary>\n<p>도커 매니페스트는 컨테이너 이미지에 대한 상세 정보를 담고 있는 메타데이터입니다. 여기에는:</p>\n<ul>\n<li>이미지가 실행될 수 있는 운영체제와 아키텍처</li>\n<li>이미지를 구성하는 레이어들의 정보</li>\n<li>이미지의 설정값 (환경 변수, 실행 명령어 등)</li>\n</ul>\n<p>등이 포함됩니다. 도커는 이 매니페스트를 읽어 해당 이미지가 현재 환경에서 실행 가능한지, 어떤 레이어들이 필요한지 등을 파악합니다.</p>\n</details>\n<h3 id=\"그럼-어떻게-하죠\" style=\"position:relative;\"><a href=\"#%EA%B7%B8%EB%9F%BC-%EC%96%B4%EB%96%BB%EA%B2%8C-%ED%95%98%EC%A3%A0\" aria-label=\"그럼 어떻게 하죠 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>그럼 어떻게 하죠?</h3>\n<p>도커 이미지 크기를 줄이기 위해서는 아래와 같은 과정을 처리할 수 있습니다.</p>\n<ul>\n<li>가능하면 가벼운 베이스 이미지를 선택할 것</li>\n<li>멀티-스테이지를 사용해서, 빌드-런타임 환경을 분리할 것</li>\n<li>다양한 최적화 방안을 고려해보기\n<ul>\n<li><code class=\"language-text\">.dockerignore</code> 파일 작성</li>\n<li><code class=\"language-text\">RUN</code> 레이어 최적화</li>\n<li>나에게 맞는 패키지<sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup>/파일을 취사선택하기</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"step-1-simple-tag를-골라봅시다\" style=\"position:relative;\"><a href=\"#step-1-simple-tag%EB%A5%BC-%EA%B3%A8%EB%9D%BC%EB%B4%85%EC%8B%9C%EB%8B%A4\" aria-label=\"step 1 simple tag를 골라봅시다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>step 1. simple tag를 골라봅시다</h3>\n<p>앞서 말씀드린 <code class=\"language-text\">latest</code> 는 shared tags 입니다. 구동하려는 호스트에 맞게 구동될 수는 있지만, 최적화는 다른 문제죠. 이럴 땐 최소한의 내용만을 컨테이너를 통한 배포를 수행할 때는 최소한의 내용만 맞추고 배포하는 것이 보다 나은 접근입니다.</p>\n<p>대표적인 베이스 이미지는 <code class=\"language-text\">Debian linux</code> 기반의  <code class=\"language-text\">slim</code> 과 <code class=\"language-text\">Alpine linux</code> 기반의 <code class=\"language-text\">alpine</code>이 있습니다.</p>\n<ul>\n<li>slim 이미지는,\n<ul>\n<li>Debian linux의 최소화 버전이며</li>\n<li>필수적인 시스템 라이브러리를 갖추고 있습니다</li>\n<li>C 라이브러리 구현체로 <code class=\"language-text\">glibc</code> 를 사용합니다. 이는 거의 대부분의 라이브러리와 호환됩니다.</li>\n</ul>\n</li>\n<li>alpine 이미지는,\n<ul>\n<li>Alpine linux에 대한 최소한의 버전이며</li>\n<li>필수적인 시스템 라이브러리로 <code class=\"language-text\">busybox</code> 를 이용합니다</li>\n<li>C 라이브러리 구현체로 <code class=\"language-text\">musl</code> libc를 사용합니다. 경량버전의 라이브러리를 추구하는 것이 목표이므로, 일부 라이브러리와 호환되지 않을 수도 있습니다.</li>\n</ul>\n</li>\n</ul>\n<p>그러면 이 둘을 사용해서 각각 빌드해볼까요?</p>\n<details>\n<summary>👨‍💻 `slim` 빌드를 해봅시다. </summary>\n<ol>\n<li><code class=\"language-text\">Dockerfile</code> 을 제작합니다.</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> python:3.12-slim       # slim은 Debian slim 이미지를 의미합니다.</span>\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /app</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> hello.py .</span>\n<span class=\"token instruction\"><span class=\"token keyword\">CMD</span> [<span class=\"token string\">\"python\"</span>, <span class=\"token string\">\"hello.py\"</span>]</span></code></pre></div>\n<ol start=\"2\">\n<li>빌드를 동일하게 해보고,</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">ocker build <span class=\"token parameter variable\">-t</span> python-hello:slim <span class=\"token builtin class-name\">.</span></code></pre></div>\n<ol start=\"3\">\n<li>사이즈를 확인해볼까요?</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">docker</span> images\nREPOSITORY          TAG            IMAGE ID       CREATED         SIZE\npython-hello        slim           2f648897463c   <span class=\"token number\">5</span> seconds ago   212MB\npython-hello        latest         746136719e90   <span class=\"token number\">12</span> days ago     <span class=\"token number\">1</span>.46GB</code></pre></div>\n</details>\n<details>\n<summary>👨‍💻 `alpine` 빌드를 해봅시다. </summary>\n<ol>\n<li><code class=\"language-text\">Dockerfile</code> 을 제작합니다.</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> python:3.12-alpine       # alpine은 Alpine 이미지를 의미합니다.</span>\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /app</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> hello.py .</span>\n<span class=\"token instruction\"><span class=\"token keyword\">CMD</span> [<span class=\"token string\">\"python\"</span>, <span class=\"token string\">\"hello.py\"</span>]</span></code></pre></div>\n<ol start=\"2\">\n<li>빌드를 동일하게 해보고,</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">ocker build <span class=\"token parameter variable\">-t</span> python-hello:alpine <span class=\"token builtin class-name\">.</span></code></pre></div>\n<ol start=\"3\">\n<li>사이즈를 확인해볼까요?</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">docker</span> images\nREPOSITORY          TAG            IMAGE ID       CREATED         SIZE\npython-hello        slim           2f648897463c   <span class=\"token number\">5</span> seconds ago   212MB\npython-hello        alpine         37a9f605a036   <span class=\"token number\">3</span> minutes ago   <span class=\"token number\">78</span>.4MB\npython-hello        latest         746136719e90   <span class=\"token number\">12</span> days ago     <span class=\"token number\">1</span>.46GB</code></pre></div>\n</details>\n<h3 id=\"step-2-멀티-스테이지-사용해보기\" style=\"position:relative;\"><a href=\"#step-2-%EB%A9%80%ED%8B%B0-%EC%8A%A4%ED%85%8C%EC%9D%B4%EC%A7%80-%EC%82%AC%EC%9A%A9%ED%95%B4%EB%B3%B4%EA%B8%B0\" aria-label=\"step 2 멀티 스테이지 사용해보기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>step 2. 멀티-스테이지 사용해보기</h3>\n<p>멀티-스테이지는 하나의 <code class=\"language-text\">Dockerfile</code>에서 다양한 스테이지로 나누어서 레이어를 쌓는 개념을 의미합니다. 그렇다면 어떤 스테이지가 있는지 살펴볼까요?</p>\n<ul>\n<li>빌드 스테이지\n<ul>\n<li>빌드 도구에 필요한 내용만을 포함합니다</li>\n<li>빌드 결과를 저장합니다</li>\n</ul>\n</li>\n<li>런타임 스테이지\n<ul>\n<li>직전 phase에서 저장한 파일들을 복사합니다.</li>\n<li>빌드 후의 내용을 구동할 최소한의 파일만을 설치합니다</li>\n<li>본 내용에서는 런타임 스테이지를 run stage, service stage 둘로 나눕니다.\n<ul>\n<li>이는 각각 실행환경 구성, 앱 실행환경 구성을 의미합니다.</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<p>그렇다면 멀티-스테이지로 빌드를 수행해볼까요?</p>\n<p>이번 예시부터는 이 <a href=\"https://github.com/max-pfeiffer/python-poetry\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">GitHub repo</a>를 사용해보겠습니다.</p>\n<h3 id=\"멀티-스테이지가-없다면\" style=\"position:relative;\"><a href=\"#%EB%A9%80%ED%8B%B0-%EC%8A%A4%ED%85%8C%EC%9D%B4%EC%A7%80%EA%B0%80-%EC%97%86%EB%8B%A4%EB%A9%B4\" aria-label=\"멀티 스테이지가 없다면 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>멀티-스테이지가 없다면?</h3>\n<p>그렇다면, 멀티-스테이지 없이 헬로글또를 찍어볼까요?</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> python:3.12-slim</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> POETRY_VERSION=1.6.1</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> APPLICATION_SERVER_PORT=8000</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> PIP_NO_CACHE_DIR=off <span class=\"token operator\">\\</span>\n    PIP_DISABLE_PIP_VERSION_CHECK=on <span class=\"token operator\">\\</span>\n    PIP_DEFAULT_TIMEOUT=100 <span class=\"token operator\">\\</span>\n    POETRY_VERSION=<span class=\"token variable\">${POETRY_VERSION}</span> <span class=\"token operator\">\\</span>\n    POETRY_HOME=<span class=\"token string\">\"/opt/poetry\"</span> <span class=\"token operator\">\\</span>\n    PYTHONUNBUFFERED=1 <span class=\"token operator\">\\</span>\n    PYTHONDONTWRITEBYTECODE=1 <span class=\"token operator\">\\</span>\n    PYTHONPATH=/application_root <span class=\"token operator\">\\</span>\n    POETRY_VIRTUALENVS_IN_PROJECT=true <span class=\"token operator\">\\</span>\n    POETRY_CACHE_DIR=<span class=\"token string\">\"/application_root/.cache\"</span> <span class=\"token operator\">\\</span>\n    VIRTUAL_ENVIRONMENT_PATH=<span class=\"token string\">\"/application_root/.venv\"</span> <span class=\"token operator\">\\</span>\n    APPLICATION_SERVER_PORT=<span class=\"token variable\">$APPLICATION_SERVER_PORT</span> <span class=\"token operator\">\\</span>\n    PATH=<span class=\"token string\">\"/opt/poetry/bin:$PATH\"</span></span>\n\n<span class=\"token comment\"># 빌드 도구 설치</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> apt-get update <span class=\"token operator\">\\</span>\n    &amp;&amp; apt-get install --no-install-recommends -y <span class=\"token operator\">\\</span>\n        build-essential</span>\n\n<span class=\"token comment\"># Poetry 설치</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> python -m venv <span class=\"token variable\">${POETRY_HOME}</span></span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> <span class=\"token variable\">${POETRY_HOME}</span>/bin/pip install -U pip setuptools</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> <span class=\"token variable\">${POETRY_HOME}</span>/bin/pip install <span class=\"token string\">\"poetry==${POETRY_VERSION}\"</span></span>\n\n<span class=\"token comment\"># 사용자 생성</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> groupadd -g 1001 python_application &amp;&amp; <span class=\"token operator\">\\</span>\n    useradd -r -u 1001 -g python_application python_application</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> <span class=\"token variable\">${PYTHONPATH}</span></span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> . <span class=\"token variable\">${PYTHONPATH}</span></span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> chown python_application:python_application <span class=\"token variable\">${PYTHONPATH}</span></span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> mkdir <span class=\"token variable\">${POETRY_CACHE_DIR}</span> &amp;&amp; chown python_application:python_application <span class=\"token variable\">${POETRY_CACHE_DIR}</span></span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">EXPOSE</span> <span class=\"token variable\">${APPLICATION_SERVER_PORT}</span></span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> ./docker/dev/entrypoint /entrypoint</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> sed -i <span class=\"token string\">'s/\\r$//g'</span> /entrypoint</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> chmod +x /entrypoint</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">USER</span> 1001</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> poetry install --without dev</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ENTRYPOINT</span> [<span class=\"token string\">\"/entrypoint\"</span>]</span></code></pre></div>\n<p>이걸로 만든 이미지의 크기를 살펴봅시다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">docker</span> images\nREPOSITORY          TAG                  IMAGE ID       CREATED          SIZE\npython-hello        slim-without-multi   f4be58bb8080   <span class=\"token number\">38</span> seconds ago   700MB</code></pre></div>\n<h3 id=\"멀티-스테이지가-있다면\" style=\"position:relative;\"><a href=\"#%EB%A9%80%ED%8B%B0-%EC%8A%A4%ED%85%8C%EC%9D%B4%EC%A7%80%EA%B0%80-%EC%9E%88%EB%8B%A4%EB%A9%B4\" aria-label=\"멀티 스테이지가 있다면 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>멀티-스테이지가 있다면?</h3>\n<p>반대로 멀티-스테이지를 추가해서 헬로글또를 찍어봅시다.</p>\n<ol>\n<li>빌드 스테이지</li>\n</ol>\n<p>빌드 스테이지는 실제 필요한 내용들만을 설치합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token comment\">### ### ### ### ### ### ###</span>\n<span class=\"token comment\"># STAGE 0. Prerequisites  #</span>\n<span class=\"token comment\">### ### ### ### ### ### ###</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> OFFICIAL_PYTHON_IMAGE=3.12</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> python:<span class=\"token variable\">${OFFICIAL_PYTHON_IMAGE}</span>-slim <span class=\"token keyword\">AS</span> build-stage        # debian slim 이미지를 빌드 스테이지로 설정합시다.</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> POETRY_VERSION=1.6.1                                        # 패키지 매니저로 poetry v1.6.1를 씁니다.</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> PIP_NO_CACHE_DIR=off \\                                      # 최적화 옵션입니다. 자세한 것은 위의 GitHub 링크를 확인해주세요!</span>\n    PIP_DISABLE_PIP_VERSION_CHECK=on \\\n    PIP_DEFAULT_TIMEOUT=100 \\\n    POETRY_VERSION=${POETRY_VERSION} \\\n    POETRY_HOME=\"/opt/poetry\"\n\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> apt-get update <span class=\"token operator\">\\</span>\n    &amp;&amp; apt-get install --no-install-recommends -y build-essential \\   # 빌드에 필요한 핵심 내용들만 설치합니다.</span>\n    &amp;&amp; rm -rf /var/lib/apt/lists/*\n\n<span class=\"token comment\"># https://python-poetry.org/docs/#installing-manually</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> python -m venv <span class=\"token variable\">${POETRY_HOME}</span>                               # 가상환경을 구성하고, poetry를 설치합니다.</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> <span class=\"token variable\">${POETRY_HOME}</span>/bin/pip install -U pip setuptools</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> <span class=\"token variable\">${POETRY_HOME}</span>/bin/pip install <span class=\"token string\">\"poetry==${POETRY_VERSION}\"</span></span></code></pre></div>\n<ol start=\"2\">\n<li>Run 스테이지</li>\n</ol>\n<ul>\n<li>실행환경을 구성하는 중간단계 입니다.</li>\n<li>필요한 부분만을 복사하고, 빌드도구를 제외합니다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token comment\">### ### ### ### ###</span>\n<span class=\"token comment\"># STAGE 1. 'run'  #</span>\n<span class=\"token comment\">### ### ### ### ###</span>\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> python:<span class=\"token variable\">${OFFICIAL_PYTHON_IMAGE}</span>-slim <span class=\"token keyword\">AS</span> run-stage</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> PATH=<span class=\"token string\">\"/opt/poetry/bin:$PATH\"</span>                    # 환경변수를 추가하여, poetry를 쓸 수 있게 구성합니다.</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> <span class=\"token options\"><span class=\"token property\">--from</span><span class=\"token punctuation\">=</span><span class=\"token string\">build-stage</span></span> /opt/poetry /opt/poetry/    # build-stage에서 필요한 내용만 가져옵니다.</span></code></pre></div>\n<ol start=\"3\">\n<li>Service 스테이지</li>\n</ol>\n<ul>\n<li>실제 애플리케이션이 구동될 환경을 구성합니다.</li>\n<li>보안설정, 런타임에 필요한 의존성을 구성하고 서비스를 구동합니다.</li>\n<li>구동 전 <code class=\"language-text\">entrypoint</code> 파일을 별도로 두고 이 파일을 entrypoint 로 구성합니다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token comment\">### ### ### ### ### ###</span>\n<span class=\"token comment\"># STAGE 2. 'service'  #</span>\n<span class=\"token comment\">### ### ### ### ### ###</span>\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> run-stage <span class=\"token keyword\">AS</span> service-stage</span>\n\n<span class=\"token instruction\"><span class=\"token keyword\">ARG</span> APPLICATION_SERVER_PORT=8000</span>\n\n    <span class=\"token comment\"># https://docs.python.org/3/using/cmdline.html#envvar-PYTHONUNBUFFERED</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> PYTHONUNBUFFERED=1 <span class=\"token operator\">\\</span>\n    <span class=\"token comment\"># https://docs.python.org/3/using/cmdline.html#envvar-PYTHONDONTWRITEBYTECODE</span>\n    PYTHONDONTWRITEBYTECODE=1 <span class=\"token operator\">\\</span>\n    PYTHONPATH=/application_root <span class=\"token operator\">\\</span>\n    <span class=\"token comment\"># https://python-poetry.org/docs/configuration/#virtualenvsin-project</span>\n    POETRY_VIRTUALENVS_IN_PROJECT=true <span class=\"token operator\">\\</span>\n    POETRY_CACHE_DIR=<span class=\"token string\">\"/application_root/.cache\"</span> <span class=\"token operator\">\\</span>\n    VIRTUAL_ENVIRONMENT_PATH=<span class=\"token string\">\"/application_root/.venv\"</span> <span class=\"token operator\">\\</span>\n    APPLICATION_SERVER_PORT=<span class=\"token variable\">$APPLICATION_SERVER_PORT</span></span>\n\n<span class=\"token comment\"># 가상환경이 먼저 실행될 수 있도록 PATH의 앞에 추가</span>\n<span class=\"token comment\"># https://docs.python.org/3/library/venv.html#how-venvs-work</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENV</span> PATH=<span class=\"token string\">\"$VIRTUAL_ENVIRONMENT_PATH/bin:$PATH\"</span></span>\n\n<span class=\"token comment\"># 권한분리를 위해 처리</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> groupadd -g 1001 python_application &amp;&amp; <span class=\"token operator\">\\</span>\n    useradd -r -u 1001 -g python_application python_application</span>\n\n<span class=\"token comment\"># WORKDIR를 애플리케이션 루트 디렉터리로 지정</span>\n<span class=\"token comment\"># https://www.uvicorn.org/settings/#development</span>\n<span class=\"token comment\"># https://docs.docker.com/engine/reference/builder/#workdir</span>\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> <span class=\"token variable\">${PYTHONPATH}</span></span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> . <span class=\"token variable\">${PYTHONPATH}</span></span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> chown python_application:python_application <span class=\"token variable\">${PYTHONPATH}</span></span>\n\n<span class=\"token comment\"># poetry 캐시 디렉터리를 만들고, 권한을 부여함. 링크 참조</span>\n<span class=\"token comment\"># https://python-poetry.org/docs/configuration/#cache-directory</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> mkdir <span class=\"token variable\">${POETRY_CACHE_DIR}</span> &amp;&amp; chown python_application:python_application <span class=\"token variable\">${POETRY_CACHE_DIR}</span></span>\n\n<span class=\"token comment\"># API 엔드포인트에 대해 문서화를 수행</span>\n<span class=\"token comment\"># https://docs.docker.com/engine/reference/builder/#expose</span>\n<span class=\"token instruction\"><span class=\"token keyword\">EXPOSE</span> <span class=\"token variable\">${APPLICATION_SERVER_PORT}</span></span>\n\n<span class=\"token comment\"># ENTRYPOINT로 사용할 파일에 대해 복사 후 내용 구성</span>\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> ./docker/dev/entrypoint /entrypoint</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> sed -i <span class=\"token string\">'s/\\r$//g'</span> /entrypoint</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> chmod +x /entrypoint</span>\n\n<span class=\"token comment\"># 컨테이너 구동 시에 부여하는 권한을 명시함</span>\n<span class=\"token instruction\"><span class=\"token keyword\">USER</span> 1001</span>\n\n<span class=\"token comment\"># poetry를 이용하여 의존성 설치</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> poetry install --without dev</span>\n\n<span class=\"token comment\"># Entrypoint 로 추가한 파일을 사용.</span>\n<span class=\"token comment\"># https://www.docker.com/blog/docker-best-practices-choosing-between-run-cmd-and-entrypoint/</span>\n<span class=\"token instruction\"><span class=\"token keyword\">ENTRYPOINT</span> [<span class=\"token string\">\"/entrypoint\"</span>]</span></code></pre></div>\n<p>이렇게 되면 용량은 얼마나 줄어들까요?</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">docker</span> images\nREPOSITORY          TAG            IMAGE ID       CREATED          SIZE\npython-hello        slim-multi     4f8e4848dc55   <span class=\"token number\">27</span> minutes ago   324MB</code></pre></div>\n<p>절반이나 줄어들었군요!</p>\n<h3 id=\"step-2-빌드-타임을-줄여봅시다\" style=\"position:relative;\"><a href=\"#step-2-%EB%B9%8C%EB%93%9C-%ED%83%80%EC%9E%84%EC%9D%84-%EC%A4%84%EC%97%AC%EB%B4%85%EC%8B%9C%EB%8B%A4\" aria-label=\"step 2 빌드 타임을 줄여봅시다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>step 2. 빌드 타임을 줄여봅시다</h3>\n<p>멀티-스테이지는 빌드타임이 얼마나 걸리는지 살펴볼까요? 이번에는 외부 패키지를 추가로 설치해서 테스트 해봅시다.\n설치 대상은 <code class=\"language-text\">pandas</code> 와 <code class=\"language-text\">matplotlib</code> 입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">docker</span> build <span class=\"token parameter variable\">-t</span> python-hello:slim-multi-2 --no-cache <span class=\"token builtin class-name\">.</span>\n<span class=\"token punctuation\">[</span>+<span class=\"token punctuation\">]</span> Building <span class=\"token number\">45</span>.6s <span class=\"token punctuation\">(</span><span class=\"token number\">20</span>/20<span class=\"token punctuation\">)</span> FINISHED                                                                                                    docker:desktop-linux\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>internal<span class=\"token punctuation\">]</span> load build definition from Dockerfile                                                                                                   <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> transferring dockerfile: <span class=\"token number\">3</span>.53kB                                                                                                                 <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>internal<span class=\"token punctuation\">]</span> load metadata <span class=\"token keyword\">for</span> docker.io/library/python:3.12-slim                                                                                    <span class=\"token number\">2</span>.6s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>internal<span class=\"token punctuation\">]</span> load .dockerignore                                                                                                                      <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> transferring context: 2B                                                                                                                        <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>internal<span class=\"token punctuation\">]</span> load build context                                                                                                                      <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> transferring context: <span class=\"token number\">87</span>.08kB                                                                                                                   <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>build-stage <span class=\"token number\">1</span>/5<span class=\"token punctuation\">]</span> FROM docker.io/library/python:3.12-slim@sha256:032c52613401895aa3d418a4c563d2d05f993bc3ecc065c8f4e2280978acd249                  <span class=\"token number\">5</span>.6s\n<span class=\"token punctuation\">(</span>생략<span class=\"token punctuation\">)</span>\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>build-stage <span class=\"token number\">2</span>/5<span class=\"token punctuation\">]</span> RUN <span class=\"token function\">apt-get</span> update     <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> --no-install-recommends <span class=\"token parameter variable\">-y</span> build-essential     <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-rf</span> /var/lib/apt/lists/*          <span class=\"token number\">12</span>.4s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>build-stage <span class=\"token number\">3</span>/5<span class=\"token punctuation\">]</span> RUN python <span class=\"token parameter variable\">-m</span> venv /opt/poetry                                                                                                   <span class=\"token number\">1</span>.9s \n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>build-stage <span class=\"token number\">4</span>/5<span class=\"token punctuation\">]</span> RUN /opt/poetry/bin/pip <span class=\"token function\">install</span> <span class=\"token parameter variable\">-U</span> pip setuptools                                                                                <span class=\"token number\">1</span>.1s \n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>build-stage <span class=\"token number\">5</span>/5<span class=\"token punctuation\">]</span> RUN /opt/poetry/bin/pip <span class=\"token function\">install</span> <span class=\"token string\">\"poetry==1.6.1\"</span>                                                                                  <span class=\"token number\">5</span>.1s \n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>run-stage <span class=\"token number\">2</span>/2<span class=\"token punctuation\">]</span> COPY <span class=\"token parameter variable\">--from</span><span class=\"token operator\">=</span>build-stage /opt/poetry /opt/poetry/                                                                                   <span class=\"token number\">0</span>.2s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>service-stage <span class=\"token number\">1</span>/9<span class=\"token punctuation\">]</span> RUN <span class=\"token function\">groupadd</span> <span class=\"token parameter variable\">-g</span> <span class=\"token number\">1001</span> python_application <span class=\"token operator\">&amp;&amp;</span>     <span class=\"token function\">useradd</span> <span class=\"token parameter variable\">-r</span> <span class=\"token parameter variable\">-u</span> <span class=\"token number\">1001</span> <span class=\"token parameter variable\">-g</span> python_application python_application                     <span class=\"token number\">0</span>.2s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>service-stage <span class=\"token number\">2</span>/9<span class=\"token punctuation\">]</span> WORKDIR /application_root                                                                                                      <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>service-stage <span class=\"token number\">3</span>/9<span class=\"token punctuation\">]</span> COPY <span class=\"token builtin class-name\">.</span> /application_root                                                                                                       <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>service-stage <span class=\"token number\">4</span>/9<span class=\"token punctuation\">]</span> RUN <span class=\"token function\">chown</span> python_application:python_application /application_root                                                              <span class=\"token number\">0</span>.1s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>service-stage <span class=\"token number\">5</span>/9<span class=\"token punctuation\">]</span> RUN <span class=\"token function\">mkdir</span> /application_root/.cache <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">chown</span> python_application:python_application /application_root/.cache                     <span class=\"token number\">0</span>.1s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>service-stage <span class=\"token number\">6</span>/9<span class=\"token punctuation\">]</span> COPY entrypoint /entrypoint                                                                                                    <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>service-stage <span class=\"token number\">7</span>/9<span class=\"token punctuation\">]</span> RUN <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s/\\r$//g'</span> /entrypoint                                                                                              <span class=\"token number\">0</span>.1s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>service-stage <span class=\"token number\">8</span>/9<span class=\"token punctuation\">]</span> RUN <span class=\"token function\">chmod</span> +x /entrypoint                                                                                                       <span class=\"token number\">0</span>.1s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>service-stage <span class=\"token number\">9</span>/9<span class=\"token punctuation\">]</span> RUN poetry <span class=\"token function\">install</span> <span class=\"token parameter variable\">--without</span> dev                                                                                               <span class=\"token number\">7</span>.4s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> exporting to image                                                                                                                                 <span class=\"token number\">8</span>.3s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> exporting layers                                                                                                                                <span class=\"token number\">6</span>.5s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> exporting manifest sha256:2e1a026e67ea60a968a576838692cc7661011085b146d3b94bff86e21c10fedd                                                      <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> exporting config sha256:f7b5913e1edb9f4566cd1bf1c1f32e0baa757f9fae90fea096917d7241a0fd6d                                                        <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> exporting attestation manifest sha256:6482e53034c92e947f0c26372d5a0fc24e24d510ec9a4a5c5ff6901310ef5263                                          <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> exporting manifest list sha256:a23299c55409341354951e7931f8bf1f38137fd21391853773255b17062c1c0f                                                 <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> naming to docker.io/library/python-hello:slim-multi-2                                                                                           <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> unpacking to docker.io/library/python-hello:slim-multi-2                                                                                        <span class=\"token number\">1</span>.8s</code></pre></div>\n<p>그렇다면, alpine 베이스 이미지로 빌드를 수행해봅시다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">docker</span> build <span class=\"token parameter variable\">-t</span> python-hello:alpine-multi-2 --no-cache <span class=\"token builtin class-name\">.</span>\n<span class=\"token punctuation\">[</span>+<span class=\"token punctuation\">]</span> Building <span class=\"token number\">90</span>.4s <span class=\"token punctuation\">(</span><span class=\"token number\">21</span>/21<span class=\"token punctuation\">)</span> FINISHED                                                                                                     docker:desktop-linux\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>internal<span class=\"token punctuation\">]</span> load build definition from Dockerfile                                                                                                    <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> transferring dockerfile: <span class=\"token number\">2</span>.18kB                                                                                                                  <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>internal<span class=\"token punctuation\">]</span> load metadata <span class=\"token keyword\">for</span> docker.io/library/python:3.12-alpine                                                                                   <span class=\"token number\">1</span>.4s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>internal<span class=\"token punctuation\">]</span> load .dockerignore                                                                                                                       <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> transferring context: 2B                                                                                                                         <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>internal<span class=\"token punctuation\">]</span> load build context                                                                                                                       <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> transferring context: <span class=\"token number\">85</span>.72kB                                                                                                                    <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>build-stage <span class=\"token number\">1</span>/5<span class=\"token punctuation\">]</span> FROM docker.io/library/python:3.12-alpine@sha256:38e179a0f0436c97ecc76bcd378d7293ab3ee79e4b8c440fdc7113670cb6e204                 <span class=\"token number\">2</span>.3s\n<span class=\"token punctuation\">(</span>생략<span class=\"token punctuation\">)</span>\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>build-stage <span class=\"token number\">2</span>/5<span class=\"token punctuation\">]</span> RUN apk <span class=\"token function\">add</span> --no-cache     gcc     python3-dev                                                                                   <span class=\"token number\">12</span>.1s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>build-stage <span class=\"token number\">3</span>/5<span class=\"token punctuation\">]</span> RUN python <span class=\"token parameter variable\">-m</span> venv /opt/poetry                                                                                                    <span class=\"token number\">2</span>.2s \n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>build-stage <span class=\"token number\">4</span>/5<span class=\"token punctuation\">]</span> RUN /opt/poetry/bin/pip <span class=\"token function\">install</span> <span class=\"token parameter variable\">-U</span> pip setuptools                                                                                 <span class=\"token number\">1</span>.3s \n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>build-stage <span class=\"token number\">5</span>/5<span class=\"token punctuation\">]</span> RUN /opt/poetry/bin/pip <span class=\"token function\">install</span> <span class=\"token string\">\"poetry==1.6.1\"</span>                                                                                   <span class=\"token number\">5</span>.7s \n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>run-stage <span class=\"token number\">2</span>/2<span class=\"token punctuation\">]</span> COPY <span class=\"token parameter variable\">--from</span><span class=\"token operator\">=</span>build-stage /opt/poetry /opt/poetry/                                                                                    <span class=\"token number\">0</span>.2s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>service-stage  <span class=\"token number\">1</span>/10<span class=\"token punctuation\">]</span> RUN addgroup <span class=\"token parameter variable\">-g</span> <span class=\"token number\">1001</span> <span class=\"token parameter variable\">-S</span> python_application <span class=\"token operator\">&amp;&amp;</span>     adduser <span class=\"token parameter variable\">-S</span> <span class=\"token parameter variable\">-u</span> <span class=\"token number\">1001</span> <span class=\"token parameter variable\">-G</span> python_application python_application                 <span class=\"token number\">0</span>.1s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>service-stage  <span class=\"token number\">2</span>/10<span class=\"token punctuation\">]</span> WORKDIR /application_root                                                                                                     <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>service-stage  <span class=\"token number\">3</span>/10<span class=\"token punctuation\">]</span> COPY <span class=\"token builtin class-name\">.</span> /application_root                                                                                                      <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>service-stage  <span class=\"token number\">4</span>/10<span class=\"token punctuation\">]</span> RUN <span class=\"token function\">chown</span> python_application:python_application /application_root                                                             <span class=\"token number\">0</span>.1s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>service-stage  <span class=\"token number\">5</span>/10<span class=\"token punctuation\">]</span> RUN <span class=\"token function\">mkdir</span> /application_root/.cache <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">chown</span> python_application:python_application /application_root/.cache                    <span class=\"token number\">0</span>.2s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>service-stage  <span class=\"token number\">6</span>/10<span class=\"token punctuation\">]</span> COPY entrypoint /entrypoint                                                                                                   <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>service-stage  <span class=\"token number\">7</span>/10<span class=\"token punctuation\">]</span> RUN <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s/\\r$//'</span> /entrypoint                                                                                              <span class=\"token number\">0</span>.2s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>service-stage  <span class=\"token number\">8</span>/10<span class=\"token punctuation\">]</span> RUN <span class=\"token function\">chmod</span> +x /entrypoint                                                                                                      <span class=\"token number\">0</span>.1s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>service-stage  <span class=\"token number\">9</span>/10<span class=\"token punctuation\">]</span> RUN apk <span class=\"token function\">add</span> --no-cache     g++     openssl                                                                                    <span class=\"token number\">8</span>.2s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>service-stage <span class=\"token number\">10</span>/10<span class=\"token punctuation\">]</span> RUN poetry <span class=\"token function\">install</span> <span class=\"token parameter variable\">--without</span> dev                                                                                             <span class=\"token number\">44</span>.2s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> exporting to image                                                                                                                                 <span class=\"token number\">11</span>.8s```\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> exporting layers                                                                                                                                 <span class=\"token number\">9</span>.2s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> exporting manifest sha256:6b7bcd80340bf252c06947fde85a4fb53012c3d8bb07ff6dfd3a8b6fe6d1022c                                                       <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> exporting config sha256:58c4058d992779af8b0e3aa67ceabd655d234d871e38af0e6996155a56ed953e                                                         <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> exporting attestation manifest sha256:e88ed3098ce10fbce9ed2452c82ada1f5ccccb7c9d094b6f2da495754249db26                                           <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> exporting manifest list sha256:b0b8cc043f1436abf29e9b45bcbcf618d0838de9d1678086c9b2b5acc1541e9b                                                  <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> naming to docker.io/library/python-hello:alpine-multi-2                                                                                          <span class=\"token number\">0</span>.0s\n <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> unpacking to docker.io/library/python-hello:alpine-multi-2                                                                                       <span class=\"token number\">2</span>.6s</code></pre></div>\n<p>빌드 시간과 크기에 대해 한번 살펴보죠.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">docker</span> images\nREPOSITORY     TAG              IMAGE ID       CREATED         SIZE\npython-hello   alpine-multi-2   b0b8cc043f14   <span class=\"token number\">2</span> minutes ago   <span class=\"token number\">1</span>.13GB\npython-hello   slim-multi-2     a23299c55409   <span class=\"token number\">3</span> minutes ago   755MB</code></pre></div>\n<table>\n<thead>\n<tr>\n<th>베이스이미지</th>\n<th>빌드된 이미지 크기</th>\n<th>소요시간(단위: 초)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>debian slim</td>\n<td><code class=\"language-text\">755 MB</code></td>\n<td><code class=\"language-text\">45.6</code></td>\n</tr>\n<tr>\n<td>alpine</td>\n<td><code class=\"language-text\">1.13 GB</code></td>\n<td><code class=\"language-text\">90.4</code></td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li>debian 베이스 이미지는 용량, 소요시간 측면 모두에서 안정적이었습니다.</li>\n<li>alpine 베이스 이미지는 빌드시간 자체도 늦고, 크기도 커졌습니다.</li>\n</ul>\n<p>그렇다면 alpine 베이스 이미지는 사용할 수 없는 걸까요? 왜 그런건지 알아보기에 앞서, 앞서  알아봅시다.</p>\n<h2 id=\"c-라이브러리-구현체와-빌드의-차이\" style=\"position:relative;\"><a href=\"#c-%EB%9D%BC%EC%9D%B4%EB%B8%8C%EB%9F%AC%EB%A6%AC-%EA%B5%AC%ED%98%84%EC%B2%B4%EC%99%80-%EB%B9%8C%EB%93%9C%EC%9D%98-%EC%B0%A8%EC%9D%B4\" aria-label=\"c 라이브러리 구현체와 빌드의 차이 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>C 라이브러리 구현체와 빌드의 차이</h2>\n<p>그렇다면 앞서 alpine linux 배포판과 debian 배포판의 차이를 알아봅시다. 이 글에서 살펴볼 둘의 주요 차이점은 C 라이브러리 구현체의 선택입니다. 각각의 특징을 살펴보겠습니다:</p>\n<h3 id=\"glibc-debian-계열\" style=\"position:relative;\"><a href=\"#glibc-debian-%EA%B3%84%EC%97%B4\" aria-label=\"glibc debian 계열 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">glibc</code> (Debian 계열)</h3>\n<ul>\n<li>리눅스 생태계의 사실상 표준 구현체입니다</li>\n<li>대부분의 파이썬 패키지가 <code class=\"language-text\">glibc</code> 기준으로 빌드되어있으니, 안정성과 호환성이 검증되어 있습니다.</li>\n<li>그런 이유로 베이스 이미지 크기가 상대적으로 큽니다</li>\n</ul>\n<h3 id=\"musl-alpine-linux\" style=\"position:relative;\"><a href=\"#musl-alpine-linux\" aria-label=\"musl alpine linux permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">musl</code> (Alpine Linux)</h3>\n<ul>\n<li>경량화된 C 라이브러리 구현체입니다</li>\n<li>단순한 구현으로 보안 공격 표면이 작습니다</li>\n<li>베이스 이미지 크기가 매우 작습니다 (Debian 대비 약 1/20)</li>\n<li>일부 바이너리와 호환성 이슈가 발생할 수 있습니다</li>\n</ul>\n<h2 id=\"python-wheels의-발전과-alpine-linux-지원\" style=\"position:relative;\"><a href=\"#python-wheels%EC%9D%98-%EB%B0%9C%EC%A0%84%EA%B3%BC-alpine-linux-%EC%A7%80%EC%9B%90\" aria-label=\"python wheels의 발전과 alpine linux 지원 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Python Wheels의 발전과 Alpine Linux 지원</h2>\n<p>과거에는 Alpine Linux에서 많은 파이썬 패키지를 설치할 때 소스로부터 직접 빌드해야 했고, 이는 컨테이너 빌드 시간을 길어지게 하는 주요 요소였습니다. 하지만 Python 패키징 생태계의 발전으로 상황이 크게 개선되었습니다.</p>\n<h3 id=\"python-패키징의-발전-과정\" style=\"position:relative;\"><a href=\"#python-%ED%8C%A8%ED%82%A4%EC%A7%95%EC%9D%98-%EB%B0%9C%EC%A0%84-%EA%B3%BC%EC%A0%95\" aria-label=\"python 패키징의 발전 과정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Python 패키징의 발전 과정</h3>\n<p>다양한 배포판에서 파이썬 패키지를 바로 설치할 수 있도록 하기 위해, 아래와 같은 PEP가 지속적으로 제안되어 왔고 또 받아들여졌습니다.</p>\n<ol>\n<li>PEP 513 (manylinux1): 최초의 호환성 있는 Linux wheel 표준 도입</li>\n<li>PEP 571 (manylinux2010): glibc 2.12 기반 호환성 확장</li>\n<li>PEP 599 (manylinux2014): 더 새로운 시스템 라이브러리 지원</li>\n<li>PEP 600 (Future manylinux): 향후 확장성을 고려한 태그 체계 도입</li>\n<li><strong>PEP 656 (musllinux)</strong>: Alpine Linux 등 <code class=\"language-text\">musl</code> 기반 배포판 공식 지원</li>\n</ol>\n<p>PEP 656이 accept 되며, <code class=\"language-text\">musl</code> 기반의 빌드가 이루어진 파이썬 패키지도 직접 다운로드 받게 되어, 이를 지원하고 빌드한 라이브러리라면 누구나 쓸 수 있게 되었습니다.</p>\n<h3 id=\"manylinux\" style=\"position:relative;\"><a href=\"#manylinux\" aria-label=\"manylinux permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>manylinux?</h3>\n<p>manylinux는 “Python wheels that work on any linux (almost).” 라는 목표를 가지고 다양한 배포판을 타겟으로 빌드하기 위해 시작된 프로젝트 입니다. 원하는 리눅스 배포판에서 라이브러리를 빌드없이 직접 다운로드 받아 쓸 수 있도록 규약을 잡기 시작한 것이라고 이해할 수 있지요(<a href=\"https://github.com/pypa/manylinux\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">manylinux 링크</a>에서 발췌하였습니다).</p>\n<div class=\"gatsby-highlight\" data-language=\"markdown\"><pre class=\"language-markdown\"><code class=\"language-markdown\"><span class=\"token title important\">manylinux\n<span class=\"token punctuation\">---</span></span>\n\nOlder archives: https://groups.google.com/forum/#!forum/manylinux-discuss\n\nThe goal of the manylinux project is to provide a convenient way to distribute binary Python extensions as wheels on Linux. This effort has produced PEP 513 (manylinux1), PEP 571 (manylinux2010), PEP 599 (manylinux2014), PEP 600 (manylinux_x_y) and PEP 656 (musllinux_x_y).</code></pre></div>\n<h3 id=\"pep-656의-의의\" style=\"position:relative;\"><a href=\"#pep-656%EC%9D%98-%EC%9D%98%EC%9D%98\" aria-label=\"pep 656의 의의 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>PEP 656의 의의</h3>\n<p>Alpine linux와 관련해서는 PEP 656(Platform Tag for Linux Distributions Using Musl)은 위 PEP의 연장선상이라 할 수 있지요. 이 표준이 받아들여지면서, <code class=\"language-text\">musl</code> 기반의 빌드된 wheel을 배포자가 업데이트 하면 사용자가 즉시 설치할 수 있게 된 것입니다. 이로 인해 alpine linux 기반의 베이스 이미지를 선택해도 빌드 시간 단축 및 의존성 문제를 해결할 수 있게 된 겁니다.</p>\n<p>이로인해 Alpine 베이스 파이썬 컨테이너를 선택하더라도 빌드 시간 단축과 이미지 크기 최적화의 이점을 누릴 수 있게 되었습니다. 특히 PEP 656 도입 이후에는 많은 패키지가 musllinux wheel을 제공하고 있고, 코어 로직이 Rust로 짜여진 파이썬 패키지들은 크로스플랫폼을 쉽게 지원하기 때문에 이런 부분에서도 선택에 제약이 크게 없습니다.</p>\n<h2 id=\"마지막으로\" style=\"position:relative;\"><a href=\"#%EB%A7%88%EC%A7%80%EB%A7%89%EC%9C%BC%EB%A1%9C\" aria-label=\"마지막으로 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>마지막으로</h2>\n<p>그렇지만 여전히 의문입니다. 그러면 언제, 어떤 시기에 적절한 베이스 이미지를 선택하면 될까요? 무턱대고 고르기에는 아무래도 의심이 듭니다. 간단하게나마 있을법한 일을 검증해보고 적절한지 예시 데이터를 보면 더욱 안심이겠죠. 그래서 다음장에는 아래의 상황에서 어떤 베이스 이미지가 좋은지 함께 살펴볼 예정입니다.</p>\n<ul>\n<li>I/O bound 태스크 중심: API 서비스를 만들고, DB에는 1억개의 데이터을 추가한 후, 쿼리 테스트 및 부하 테스트를 수행하여 성능을 리포트</li>\n<li>CPU bound 태스크 중심: 매우 큰 데이터를 pandas로 처리, matplotlib으로 연산하게 구성해보고 성능을 리포트</li>\n</ul>\n<p>긴 글 읽어주셔서 감사합니다.</p>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\">패키지(이 글에서는 파이썬 패키지를 의미)는 <code class=\"language-text\">pip</code> 등으로 설치할 수 있는 외부 모듈의 모음을 의미합니다. 쉽게 말하자면 파이썬 라이브러리라고 할 수 있지요.<a href=\"#fnref-1\" class=\"footnote-backref\">↩</a></li>\n</ol>\n</div>","fields":{"slug":"/devlog/python/2024-10-26---python-container-101-pt02//devlog/python/2024-10-26-python-container-101-pt02","tagSlugs":["/tag/python/","/tag/geultto/"]},"frontmatter":{"date":"2024-10-26T05:08:00.000Z","description":"컨테이너 사이즈 최소화의 필요성과, 최소화 과정 중 파이썬 라이브러리 설치 과정에서의 최적화 제안(PEP 656)을 소개합니다.","tags":["python","geultto"],"title":"[연재] 파이썬 컨테이너 선택 제 2형 - 파이썬 컨테이너 최적화","socialImage":{"publicURL":{"publicURL":"/static/f362749d11992f125f0cdfe8205b50ef/sangdo-dong.jpg"}}}}},"pageContext":{"slug":"/devlog/python/2024-10-26---python-container-101-pt02//devlog/python/2024-10-26-python-container-101-pt02"}},"staticQueryHashes":["251939775","357378587","401334301"]}