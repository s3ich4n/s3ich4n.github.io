<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 4.25.4"/><meta name="description" content="파이썬으로 살펴보는 아키텍처 패턴을 읽고 이해한 내용을 작성합니다. 챕터 10, 커맨드와 커맨드 핸들러에 대한 내용입니다." data-gatsby-head="true"/><meta name="twitter:card" content="summary_large_image" data-gatsby-head="true"/><meta name="twitter:title" content="파이썬으로 살펴보는 아키텍처 패턴 (10) - 팔공산 창고" data-gatsby-head="true"/><meta name="twitter:description" content="파이썬으로 살펴보는 아키텍처 패턴을 읽고 이해한 내용을 작성합니다. 챕터 10, 커맨드와 커맨드 핸들러에 대한 내용입니다." data-gatsby-head="true"/><meta name="og:title" content="파이썬으로 살펴보는 아키텍처 패턴 (10) - 팔공산 창고" data-gatsby-head="true"/><meta name="og:type" content="website" data-gatsby-head="true"/><meta name="og:description" content="파이썬으로 살펴보는 아키텍처 패턴을 읽고 이해한 내용을 작성합니다. 챕터 10, 커맨드와 커맨드 핸들러에 대한 내용입니다." data-gatsby-head="true"/><meta name="image" content="https://blog.s3ich4n.me[object Object]" data-gatsby-head="true"/><meta name="og:image" content="https://blog.s3ich4n.me[object Object]" data-gatsby-head="true"/><meta name="twitter:image" content="https://blog.s3ich4n.me[object Object]" data-gatsby-head="true"/><meta name="theme-color" content="hsl(31, 92%, 62%)"/><style data-href="/styles.1fbe3e33e3d898c35e17.css" data-identity="gatsby-global-css">:after,:before,:root{--color-white:#fff;--color-primary:#5c92ff;--color-secondary:#f7a145;--color-prism-background:#eaeaeb;--color-typographic-base-font:#242933;--color-typographic-link-p-font:#5c92ff;--color-typographic-link-s-font:#f7a145;--color-page-border:#eaeaeb;--color-page-background:#fff;--color-sidebar-border:#eaeaeb;--color-sidebar-border-fade:#fff;--color-contacts-border:#eaeaeb;--color-button-border:#eaeaeb;--color-button-color:#242933;--color-theme-switcher:#3f485a;--color-theme-switcher-hover:#5c92ff}.dark :after,.dark :before,:root.dark{--color-white:#fff;--color-primary:#5c92ff;--color-secondary:#f7a145;--color-prism-background:#191d24;--color-typographic-base-font:#fff;--color-typographic-link-p-font:#5c92ff;--color-typographic-link-s-font:#f7a145;--color-page-border:#3f485a;--color-page-background:#242933;--color-sidebar-border:#3f485a;--color-sidebar-border-fade:#242933;--color-contacts-border:#3f485a;--color-button-border:#3f485a;--color-button-color:#fff;--color-theme-switcher:#eaeaeb;--color-theme-switcher-hover:#5c92ff}html{font-size:100}body{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;background:var(--color-page-background);color:var(--color-typographic-base-font);font-size:16px;line-height:1.625;margin:0 0 0 calc(100vw - 100%);text-rendering:optimizelegibility}body,h1,h2,h3,h4,h5,h6{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif}h1,h2,h3,h4,h5,h6{font-weight:600}h1{font-size:40px;line-height:52px;margin-bottom:26px;margin-top:104px}h2{font-size:27px;line-height:39px}h2,h3{margin-bottom:13px;margin-top:52px}h3{font-size:22px;line-height:26px}h4{font-size:19.2px;margin-top:39px}h4,h5{line-height:26px;margin-bottom:13px}h5,h6{font-size:16px;margin-top:65px}h6{line-height:26px;margin-bottom:13px}img{max-width:100%}hr,img{border:0;display:block}hr{background-image:linear-gradient(180deg,transparent 1px,transparent 11px,#242933 0,#242933 15px,transparent 0,transparent 26px);background-size:100% 26px;color:var(--color-typographic-base-font);height:26px;margin:52px auto;width:100px}a{color:var(--color-typographic-link-p-font);text-decoration:none}a:active,a:focus,a:hover{color:var(--color-typographic-link-s-font)}b,strong{font-weight:600}ul{list-style:square;margin-bottom:26px}ul li{margin-bottom:10px;padding:0 5px}p{line-height:26px;margin-bottom:26px}blockquote{font-style:italic;padding:0;text-align:center}figure{display:block;height:auto;width:100%}figcaption{color:var(--color-typographic-base-font);font-size:14px;font-style:italic;line-height:19.5px;margin-bottom:0;margin-top:6.5px;text-align:center}@media screen and (min-width:685px){figure.float-left,figure.float-right{max-width:310px;padding:0 26px}.float-right{float:right}.float-left{float:left}}code[class*=language-],pre[class*=language-]{word-wrap:normal;color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:var(--color-prism-background)}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#073642}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{background:#eee8d5;color:#657b83;cursor:help}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.Feed-module--feed--a6204 .Feed-module--item--c7a63{margin-bottom:32.5px}.Feed-module--feed--a6204 .Feed-module--item--c7a63:last-child{margin-bottom:13px}.Feed-module--feed--a6204 .Feed-module--item--c7a63 .Feed-module--title--f252f{font-size:27px;line-height:39px;margin-bottom:13px;margin-top:0}.Feed-module--feed--a6204 .Feed-module--item--c7a63 .Feed-module--title--f252f .Feed-module--link--6123b{color:var(--color-typographic-base-font)}.Feed-module--feed--a6204 .Feed-module--item--c7a63 .Feed-module--title--f252f .Feed-module--link--6123b:focus,.Feed-module--feed--a6204 .Feed-module--item--c7a63 .Feed-module--title--f252f .Feed-module--link--6123b:hover{border-bottom:1px solid #242933;color:var(--color-typographic-base-font)}.Feed-module--feed--a6204 .Feed-module--item--c7a63 .Feed-module--description--57348{font-size:16px;line-height:26px;margin-bottom:19.5px}.Feed-module--feed--a6204 .Feed-module--item--c7a63 .Feed-module--meta--250c2 .Feed-module--time--72864{color:var(--color-typographic-base-font);font-size:14px;font-weight:600;text-transform:uppercase}.Feed-module--feed--a6204 .Feed-module--item--c7a63 .Feed-module--meta--250c2 .Feed-module--divider--81a18{margin:0 13px}.Feed-module--feed--a6204 .Feed-module--item--c7a63 .Feed-module--meta--250c2 .Feed-module--category--59f58 .Feed-module--link--6123b{color:var(--color-secondary);font-size:14px;font-weight:600;text-transform:uppercase}.Feed-module--feed--a6204 .Feed-module--item--c7a63 .Feed-module--meta--250c2 .Feed-module--category--59f58 .Feed-module--link--6123b:focus,.Feed-module--feed--a6204 .Feed-module--item--c7a63 .Feed-module--meta--250c2 .Feed-module--category--59f58 .Feed-module--link--6123b:hover{color:#5c92ff}.Feed-module--feed--a6204 .Feed-module--item--c7a63 .Feed-module--more--51a4e{color:var(--color-primary);font-size:16px}.Feed-module--feed--a6204 .Feed-module--item--c7a63 .Feed-module--more--51a4e:focus,.Feed-module--feed--a6204 .Feed-module--item--c7a63 .Feed-module--more--51a4e:hover{border-bottom:1px solid #5c92ff;color:var(--color-primary)}.Layout-module--layout--2c933{margin-left:auto;margin-right:auto;max-width:1070px}.Layout-module--layout--2c933:before{content:"";display:table}.Layout-module--layout--2c933:after{clear:both;content:"";display:table}.Page-module--page--24e03{margin-bottom:52px}.Page-module--page--24e03 .Page-module--inner--4b31d{padding:26px 19.5px 0}.Page-module--page--24e03 .Page-module--title--90338{font-size:40px;font-weight:600;line-height:52px;margin-bottom:37.7px;margin-top:0}.Page-module--page--24e03 .Page-module--body--561c4{font-size:16px;line-height:26px;margin:0 0 26px}@media screen and (min-width:685px){.Page-module--page--24e03{width:calc(58.275% - 12.5px)}.Page-module--page--24e03:nth-child(1n){clear:none;float:left;margin-right:30px}.Page-module--page--24e03:last-child{margin-right:0}.Page-module--page--24e03:nth-child(12n){float:right;margin-right:0}.Page-module--page--24e03:nth-child(12n+1){clear:both}.Page-module--page--24e03 .Page-module--inner--4b31d{padding:32.5px 19.5px 0}}@media screen and (min-width:960px){.Page-module--page--24e03{width:calc(66.6% - 10px)}.Page-module--page--24e03:nth-child(1n){clear:none;float:left;margin-right:30px}.Page-module--page--24e03:last-child{margin-right:0}.Page-module--page--24e03:nth-child(3n){float:right;margin-right:0}.Page-module--page--24e03:nth-child(3n+1){clear:both}.Page-module--page--24e03 .Page-module--inner--4b31d{padding:39px 26px 0}}.Pagination-module--pagination--d61cb{display:flex;margin-top:52px}.Pagination-module--pagination--d61cb .Pagination-module--previous--4a76b{text-align:left;width:50%}.Pagination-module--pagination--d61cb .Pagination-module--previous--4a76b .Pagination-module--previousLink--5590d{color:var(--color-secondary);font-size:26px;font-weight:700}.Pagination-module--pagination--d61cb .Pagination-module--previous--4a76b .Pagination-module--previousLink--5590d:focus,.Pagination-module--pagination--d61cb .Pagination-module--previous--4a76b .Pagination-module--previousLink--5590d:hover{color:var(--color-primary)}.Pagination-module--pagination--d61cb .Pagination-module--previous--4a76b .Pagination-module--previousLink--5590d.Pagination-module--disable--7e105{color:#3f485a;pointer-events:none}.Pagination-module--pagination--d61cb .Pagination-module--next--1cab8{text-align:right;width:50%}.Pagination-module--pagination--d61cb .Pagination-module--next--1cab8 .Pagination-module--nextLink--532ff{color:var(--color-secondary);font-size:26px;font-weight:700}.Pagination-module--pagination--d61cb .Pagination-module--next--1cab8 .Pagination-module--nextLink--532ff:focus,.Pagination-module--pagination--d61cb .Pagination-module--next--1cab8 .Pagination-module--nextLink--532ff:hover{color:var(--color-primary)}.Pagination-module--pagination--d61cb .Pagination-module--next--1cab8 .Pagination-module--nextLink--532ff.Pagination-module--disable--7e105{color:#3f485a;pointer-events:none}.Button-module--button--b1113{border:1px solid var(--color-button-border);border-radius:20px;color:var(--color-button-color);display:inline-block;font-size:16px;font-weight:400;height:40px;line-height:40px;margin-left:auto;margin-right:auto;padding:0 26px;text-align:center;text-decoration:none}.Button-module--button--b1113:focus,.Button-module--button--b1113:hover{color:#5c92ff}.ThemeSwitcher-module--themeSwitcher--8a77f{--color:var(--color-theme-switcher)}.ThemeSwitcher-module--themeSwitcher--8a77f .ThemeSwitcher-module--button--7cb7b{align-items:center;background:transparent;border:0;cursor:pointer;display:flex;justify-content:center;outline:0}.ThemeSwitcher-module--themeSwitcher--8a77f .ThemeSwitcher-module--button--7cb7b svg{stroke:var(--color);pointer-events:none;transition:stroke .4s}.ThemeSwitcher-module--themeSwitcher--8a77f .ThemeSwitcher-module--button--7cb7b:hover{--color:var(--color-theme-switcher-hover)}.ThemeSwitcher-module--themeSwitcher--8a77f .ThemeSwitcher-module--moon--10537{stroke-dasharray:0 1px;opacity:0;transition:stroke-dasharray .2s ease-in,opacity .4s ease-in}.ThemeSwitcher-module--themeSwitcher--8a77f .ThemeSwitcher-module--sun--2163a{stroke-dasharray:1px 1px;opacity:1;transition:stroke-dasharray .2s ease-in,opacity .4s ease-in}.ThemeSwitcher-module--themeSwitcher--8a77f.ThemeSwitcher-module--dark--6db0c .ThemeSwitcher-module--moon--10537{stroke-dasharray:1px 1px;opacity:1}.ThemeSwitcher-module--themeSwitcher--8a77f.ThemeSwitcher-module--dark--6db0c .ThemeSwitcher-module--sun--2163a{stroke-dasharray:0 1px;opacity:0}.Author-module--author--cbd31 .Author-module--photo--9787b{background-clip:padding-box;border-radius:50%;display:inline-block;height:75px;margin-bottom:0;width:75px}.Author-module--author--cbd31 .Author-module--photo--9787b img{border-radius:50%}.Author-module--author--cbd31 .Author-module--title--cf7e5{font-size:18px;font-weight:600;line-height:29.25px;margin:0}.Author-module--author--cbd31 .Author-module--title--cf7e5 .Author-module--link--09c17,.Author-module--author--cbd31 .Author-module--title--cf7e5 .Author-module--link--09c17:focus,.Author-module--author--cbd31 .Author-module--title--cf7e5 .Author-module--link--09c17:hover{color:var(--color-typographic-base-font)}.Author-module--author--cbd31 .Author-module--bio--8168d,.Author-module--author--cbd31 .Author-module--subtitle--86ec5{color:#7f8ba4;line-height:26px;margin-bottom:26px}.Author-module--author--cbd31 .Author-module--titleContainer--4f576{align-items:center;display:flex;justify-content:space-between;margin:13px 0}.Categories-module--categories--f3389{color:#7f8ba4;font-size:14px}.Icon-module--icon--1d7da{fill:currentcolor;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;speak:none;stroke:currentcolor;stroke-width:0;display:inline-block;font-style:normal;font-variant:normal;font-weight:400;height:1em;line-height:1em;text-align:center;text-transform:none;width:1em}.Contacts-module--contacts--09178{margin-bottom:26px}.Contacts-module--contacts--09178 .Contacts-module--list--9670b{display:flex;flex-flow:row wrap;flex-grow:0;flex-shrink:0;list-style:none;margin:13px 0;max-width:165px;padding:0}.Contacts-module--contacts--09178 .Contacts-module--list--9670b .Contacts-module--item--f9cb0{align-content:center;align-items:center;border:1px solid var(--color-contacts-border);border-radius:50%;display:flex;height:40px;justify-content:center;line-height:40px;margin:6.5px;padding:0;text-align:center;width:40px}.Contacts-module--contacts--09178 .Contacts-module--list--9670b .Contacts-module--item--f9cb0:nth-child(3n+1){margin-left:0}.Contacts-module--contacts--09178 .Contacts-module--list--9670b .Contacts-module--item--f9cb0 .Contacts-module--link--de1e0{border:0;color:var(--color-typographic-base-font);display:flex}.Contacts-module--contacts--09178 .Contacts-module--list--9670b .Contacts-module--item--f9cb0 .Contacts-module--link--de1e0:focus,.Contacts-module--contacts--09178 .Contacts-module--list--9670b .Contacts-module--item--f9cb0 .Contacts-module--link--de1e0:hover{color:var(--color-typographic-link-p-font)}.Copyright-module--copyright--2c602{color:#7f8ba4;font-size:14px}.Menu-module--menu--113a9{margin-bottom:26px}.Menu-module--menu--113a9 .Menu-module--list--e1ae3{list-style:none;margin:0;padding:0}.Menu-module--menu--113a9 .Menu-module--list--e1ae3 .Menu-module--item--8b679{margin:13px 0;padding:0}.Menu-module--menu--113a9 .Menu-module--list--e1ae3 .Menu-module--item--8b679 .Menu-module--link--a6f02{border:0;color:var(--color-typographic-base-font);font-size:16px;font-weight:400}.Menu-module--menu--113a9 .Menu-module--list--e1ae3 .Menu-module--item--8b679 .Menu-module--link--a6f02:focus,.Menu-module--menu--113a9 .Menu-module--list--e1ae3 .Menu-module--item--8b679 .Menu-module--link--a6f02:hover{border-bottom:1px solid #5c92ff;color:#5c92ff}.Menu-module--menu--113a9 .Menu-module--list--e1ae3 .Menu-module--item--8b679 .Menu-module--link--a6f02.Menu-module--active--6cb74{border-bottom:1px solid var(--color-typographic-base-font);color:var(--color-typographic-base-font)}.Tags-module--tags--28a57{color:#7f8ba4;font-size:14px}.Sidebar-module--sidebar--1bfa1{width:100%}.Sidebar-module--sidebar--1bfa1 .Sidebar-module--inner--344d0{padding:26px 19.5px 0;position:relative}.Sidebar-module--sidebar--1bfa1 .Sidebar-module--inner--344d0:after{background:var(--color-sidebar-border);background:linear-gradient(to bottom,var(--color-sidebar-border) 0,var(--color-sidebar-border) 48%,var(--color-sidebar-border-fade) 100%)}@media screen and (min-width:685px){.Sidebar-module--sidebar--1bfa1{width:calc(41.625% - 17.5px)}.Sidebar-module--sidebar--1bfa1:nth-child(1n){clear:none;float:left;margin-right:30px}.Sidebar-module--sidebar--1bfa1:last-child{margin-right:0}.Sidebar-module--sidebar--1bfa1:nth-child(12n){float:right;margin-right:0}.Sidebar-module--sidebar--1bfa1:nth-child(12n+1){clear:both}.Sidebar-module--sidebar--1bfa1 .Sidebar-module--inner--344d0{padding:32.5px 19.5px 0}.Sidebar-module--sidebar--1bfa1 .Sidebar-module--inner--344d0:after{bottom:0;content:"";height:540px;position:absolute;right:-10px;top:30px;width:1px}}@media screen and (min-width:960px){.Sidebar-module--sidebar--1bfa1{width:calc(33.3% - 20px)}.Sidebar-module--sidebar--1bfa1:nth-child(1n){clear:none;float:left;margin-right:30px}.Sidebar-module--sidebar--1bfa1:last-child{margin-right:0}.Sidebar-module--sidebar--1bfa1:nth-child(3n){float:right;margin-right:0}.Sidebar-module--sidebar--1bfa1:nth-child(3n+1){clear:both}.Sidebar-module--sidebar--1bfa1 .Sidebar-module--inner--344d0{padding:39px}}.Author-module--author--1c58d{border-top:1px solid var(--color-page-border);line-height:26px;margin-bottom:52px;margin-top:26px;max-width:920px;padding-top:26px}.Author-module--author--1c58d .Author-module--bio--08950 .Author-module--twitter--90647{display:block;text-decoration:underline}.Author-module--author--1c58d .Author-module--bio--08950 .Author-module--twitter--90647:focus,.Author-module--author--1c58d .Author-module--bio--08950 .Author-module--twitter--90647:hover{color:var(--color-typographic-link-s-font)}@media screen and (min-width:685px){.Author-module--author--1c58d{margin-left:auto;margin-right:auto}}.Content-module--content--80d58{margin:0 auto;max-width:1070px;padding:0 13px}.Content-module--content--80d58 .Content-module--title--09504{font-size:32px;font-weight:600;line-height:42.9px;margin:26px auto 0;max-width:920px;text-align:center}.Content-module--content--80d58 .Content-module--body--726c2 figure{margin-bottom:26px}.Content-module--content--80d58 .Content-module--body--726c2 figure blockquote{font-style:italic;margin-top:0;padding:26px 0;text-align:center}.Content-module--content--80d58 .Content-module--body--726c2 figure blockquote p{font-size:26.9072px;line-height:39px;margin-bottom:26px;margin-top:0;max-width:920px}.Content-module--content--80d58 .Content-module--body--726c2 a{text-decoration:underline}.Content-module--content--80d58 .Content-module--body--726c2 *{margin-left:auto;margin-right:auto;max-width:920px}.Content-module--content--80d58 .Content-module--body--726c2 h2>a{visibility:hidden}.Content-module--content--80d58 .Content-module--body--726c2 h2>a>svg{fill:var(--color-typographic-base-font)}.Content-module--content--80d58 .Content-module--body--726c2 img{max-width:100%}@media screen and (min-width:960px){.Content-module--content--80d58{padding:0}.Content-module--content--80d58 .Content-module--title--09504{font-size:48px;line-height:58.5px;margin-bottom:39px;margin-top:58.5px}.Content-module--content--80d58 .Content-module--body--726c2,.Content-module--content--80d58 .Content-module--body--726c2 p{font-size:18px;line-height:29.25px;margin-bottom:29.25px}.Content-module--content--80d58 .Content-module--body--726c2 h2>a{padding-right:13px;visibility:unset}}.Meta-module--meta--dae0a .Meta-module--date--4d30d{font-style:italic}.Tags-module--tags--18589{margin-bottom:13px}.Tags-module--tags--18589 .Tags-module--list--82ae6{list-style:none;padding:0}.Tags-module--tags--18589 .Tags-module--list--82ae6 .Tags-module--item--52015{display:inline-block;margin:6.5px 0}@media screen and (min-width:685px){.Tags-module--tags--18589 .Tags-module--list--82ae6 .Tags-module--item--52015:first-child{margin-left:0;padding-left:0}}.Post-module--post--3a994 .Post-module--content--3c6e5{margin:0 auto}.Post-module--post--3a994 .Post-module--comments--d3b99,.Post-module--post--3a994 .Post-module--footer--f8705{margin:0 auto;max-width:920px;padding:0 13px}.Post-module--post--3a994 .Post-module--buttons--2972d{align-items:center;display:flex;justify-content:center;margin:26px 0 0;text-align:center}.Post-module--post--3a994 .Post-module--buttons--2972d .Post-module--buttonArticles--d793a{margin:0 13px 0 0}@media screen and (min-width:960px){.Post-module--post--3a994 .Post-module--comments--d3b99,.Post-module--post--3a994 .Post-module--footer--f8705{padding:0}.Post-module--post--3a994 .Post-module--buttons--2972d{left:30px;margin:0 13px 0 0;max-width:none;position:fixed;top:30px}}</style><title data-gatsby-head="true">파이썬으로 살펴보는 아키텍처 패턴 (10) - 팔공산 창고</title><link rel="alternate" type="application/rss+xml" title="팔공산 창고" href="/rss.xml"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/><script async="" src="https://www.googletagmanager.com/gtag/js?id="></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', '', {"send_page_view":false});
      }
      </script><link rel="sitemap" type="application/xml" href="/sitemap/sitemap-index.xml"/><link rel="icon" href="/favicon-32x32.png?v=4c2c993a06ee0fd0ee953020b09128a9" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=4c2c993a06ee0fd0ee953020b09128a9"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=4c2c993a06ee0fd0ee953020b09128a9"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=4c2c993a06ee0fd0ee953020b09128a9"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=4c2c993a06ee0fd0ee953020b09128a9"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=4c2c993a06ee0fd0ee953020b09128a9"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=4c2c993a06ee0fd0ee953020b09128a9"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=4c2c993a06ee0fd0ee953020b09128a9"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=4c2c993a06ee0fd0ee953020b09128a9"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script></head><body><script>
          void function() {
            var cachedMode;

            try {
              var preferredTheme = JSON.parse(localStorage.getItem('diesel:theme-atom'));

              if (preferredTheme && preferredTheme.mode) {
                cachedMode = preferredTheme.mode;
              }
            } catch (err) { }

            function setTheme(newTheme) {
              document.documentElement.className = newTheme;
            }

            var darkQuery = window.matchMedia('(prefers-color-scheme: dark)');

            setTheme(cachedMode || (darkQuery.matches ? 'dark' : 'light'));
          }()
        </script><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="Layout-module--layout--2c933"><div class="Post-module--post--3a994"><div class="Post-module--buttons--2972d"><a class="Button-module--button--b1113 Post-module--buttonArticles--d793a" href="/">All Articles</a></div><div class="Post-module--content--3c6e5"><div class="Content-module--content--80d58"><h1 class="Content-module--title--09504">파이썬으로 살펴보는 아키텍처 패턴 (10)</h1><div class="Content-module--body--726c2"><p>이 내용은 “파이썬으로 살펴보는 아키텍처 패턴” 을 읽고 작성한 내용입니다. 블로그 게시글과, 작성한 코드를 함께 보시면 더욱 좋습니다.</p>
<p>10장은 해당 코드를 살펴봐주세요. <a href="https://github.com/s3ich4n/cosmicpython-study/tree/main/pt2/ch10" target="_blank" rel="nofollow noopener noreferrer">코드 링크</a></p>
<h1 id="10장-커맨드와-커맨드-핸들러" style="position:relative;"><a href="#10%EC%9E%A5-%EC%BB%A4%EB%A7%A8%EB%93%9C%EC%99%80-%EC%BB%A4%EB%A7%A8%EB%93%9C-%ED%95%B8%EB%93%A4%EB%9F%AC" aria-label="10장 커맨드와 커맨드 핸들러 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>10장 커맨드와 커맨드 핸들러</h1>
<p>이전 장에서는 시스템 입력을 표현하기 위해 이벤트를 사용하는 방법을 익혔고, 애플리케이션을 메시지 처리 기계로 바꿨다.</p>
<p>이를 위해 모든 유스케이스 함수를 이벤트 핸들러로 바꿨다. API는 새 배치 생성 호출을 받으면 <code class="language-text">BatchCreated</code> 이벤트를 만들어서 내부 이벤트처럼 처리한다. 그런데 배치가 생성되지도 않았는데 API를 호출한다? 뭔가 이상하다(라고 하네요?)</p>
<p>이벤트와 같은 메시지 버스를 다루지만 약간 다른 규칙으로 처리하는 커맨드를 도입하여 이런 사항을 수정한다.</p>
<h1 id="101-커맨드와-이벤트" style="position:relative;"><a href="#101-%EC%BB%A4%EB%A7%A8%EB%93%9C%EC%99%80-%EC%9D%B4%EB%B2%A4%ED%8A%B8" aria-label="101 커맨드와 이벤트 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>10.1 커맨드와 이벤트</h1>
<p>이벤트와 마찬가지로 커맨드(<em>command</em>)도 메시지의 일종이다. 시스템의 한 부분에서 다른 부분으로 전달되는 명령이 커맨드다. 커맨드도 아무 메소드 없는 데이터 구조로 표현하고 이벤트처럼 처리하는데 <strong>그 둘의 차이가 정말 중요하다!</strong></p>
<p>커맨드는 한 액터<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup>로부터 다른 구체적인 액터에게 전달된다. 보내는 액터는 받는 액터가 커맨드를 받고 작업을 해주기를 바란다. API 핸들러에 폼을 전달하는 행동은 커맨드를 전달하는 행동과 같다. 그래서 커맨드 이름은 명령형 동사구(<em>imperative mood verb</em>)다. 예를 들면 아래와 같다:</p>
<ul>
<li>Allocate stock</li>
<li>Delay shipment</li>
</ul>
<p>커맨드는 의도(<em>intent</em>)를 잡아낸다. 커맨드는 시스템이 어떤 일을 수행하길 바라는 의도를 드러낸다. 그 결과로 커맨드를 보내는 액터는 커맨드 리시버(<em>reciever</em>)가 커맨드 처리에 실패했을 때 오류를 돌려받길 바란다.</p>
<p>이벤트(<em>event</em>)는 액터가 관심있는 모든 리스너에게 보내는 메시지다. <code class="language-text">BatchQuantityChanged</code> 라는 이벤트를 publish 해도 보내는 쪽(<em>sender</em>)은 누가 이걸 받는지 모른다. 아래 표는 커맨드와 이벤트의 차이다.</p>
<table>
<thead>
<tr>
<th></th>
<th>이벤트</th>
<th>커맨드</th>
</tr>
</thead>
<tbody>
<tr>
<td>이름</td>
<td>과거형</td>
<td>명령형</td>
</tr>
<tr>
<td>오류 처리</td>
<td>(송신하는 쪽과) 독립적으로 실패함</td>
<td>(송신하는 쪽에 오류를 돌려주며) 시끄럽게 실패함</td>
</tr>
<tr>
<td>누구에게</td>
<td></td>
<td></td>
</tr>
<tr>
<td>보내나?</td>
<td>모든 리스너</td>
<td>정해진 수신자</td>
</tr>
</tbody>
</table>
<p>현재 어떤 커맨드가 있는지 살펴보자.</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> dataclasses <span class="token keyword">import</span> dataclass

<span class="token keyword">class</span> <span class="token class-name">Command</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>

<span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword">class</span> <span class="token class-name">Allocate</span><span class="token punctuation">(</span>Command<span class="token punctuation">)</span><span class="token punctuation">:</span>               <span class="token comment"># 1)</span>
    order_id<span class="token punctuation">:</span> <span class="token builtin">str</span>
    sku<span class="token punctuation">:</span> <span class="token builtin">str</span>
    qty<span class="token punctuation">:</span> <span class="token builtin">int</span>

<span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword">class</span> <span class="token class-name">CreateBatch</span><span class="token punctuation">(</span>Command<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token comment"># 2)</span>
    ref<span class="token punctuation">:</span> <span class="token builtin">str</span>
    sku<span class="token punctuation">:</span> <span class="token builtin">str</span>
    qty<span class="token punctuation">:</span> <span class="token builtin">int</span>
    eta<span class="token punctuation">:</span> <span class="token builtin">str</span>

<span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword">class</span> <span class="token class-name">ChangeBatchQuantity</span><span class="token punctuation">(</span>Command<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 3)</span>
    ref<span class="token punctuation">:</span> <span class="token builtin">str</span>
    qty<span class="token punctuation">:</span> <span class="token builtin">int</span></code></pre></div>
<ol>
<li><code class="language-text">AllocationRequired</code> 이벤트를 대신한다</li>
<li><code class="language-text">BatchCreated</code> 이벤트를 대신한다</li>
<li><code class="language-text">BatchQuantityChanged</code> 이벤트를 대신한다</li>
</ol>
<h1 id="102-예외-처리-방식의-차이점" style="position:relative;"><a href="#102-%EC%98%88%EC%99%B8-%EC%B2%98%EB%A6%AC-%EB%B0%A9%EC%8B%9D%EC%9D%98-%EC%B0%A8%EC%9D%B4%EC%A0%90" aria-label="102 예외 처리 방식의 차이점 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>10.2 예외 처리 방식의 차이점</h1>
<p>이름, 동사를 바꾸는건 뭐 IDE한테 맡기면 그만이지만 로직을 어떻게 바꿔야하는지(메시지 버스 변경 등)을 살펴보자</p>
<p>커맨드, 이벤트를 통으로 처리하는 값을 메시지(<code class="language-text">Message</code>)라 정의하고 이를 <code class="language-text">Union</code> 으로 처리하자!</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">Message <span class="token operator">=</span> Union<span class="token punctuation">[</span>commands<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> events<span class="token punctuation">.</span>Event<span class="token punctuation">]</span>                           <span class="token comment"># 1)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">handle</span><span class="token punctuation">(</span>
        message<span class="token punctuation">:</span> Message<span class="token punctuation">,</span>                                                 <span class="token comment"># 1)</span>
        uow<span class="token punctuation">:</span> unit_of_work<span class="token punctuation">.</span>AbstractUnitOfWork<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    results <span class="token operator">=</span> deque<span class="token punctuation">(</span><span class="token punctuation">)</span>
    queue<span class="token punctuation">:</span> deque<span class="token punctuation">[</span>Message<span class="token punctuation">]</span> <span class="token operator">=</span> deque<span class="token punctuation">(</span><span class="token punctuation">[</span>message<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> queue<span class="token punctuation">:</span>
        message <span class="token operator">=</span> queue<span class="token punctuation">.</span>popleft<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> events<span class="token punctuation">.</span>Event<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">await</span> handle_event<span class="token punctuation">(</span>message<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> uow<span class="token punctuation">)</span>                       <span class="token comment"># 2)</span>
        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> commands<span class="token punctuation">.</span>Command<span class="token punctuation">)</span><span class="token punctuation">:</span>
            result <span class="token operator">=</span> <span class="token keyword">await</span> handle_command<span class="token punctuation">(</span>message<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> uow<span class="token punctuation">)</span>            <span class="token comment"># 3)</span>
            results<span class="token punctuation">.</span>append<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>message<span class="token punctuation">}</span></span><span class="token string"> was not a Command or Event'</span></span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> results</code></pre></div>
<ol>
<li>메시지라는 값을 만들고, 커맨드/이벤트에 대해 받을 수 있게 해놨다</li>
<li>이벤트 핸들러에 대해 별도로 분리했다. 진입점도 분리되어있다.</li>
<li>커맨드 핸들러에 대해 별도로 분리했다. 진입점도 분리되어있다.</li>
</ol>
<p>이벤트 처리 방안은 아래와 같다:</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">handle_event</span><span class="token punctuation">(</span>
        event<span class="token punctuation">:</span> events<span class="token punctuation">.</span>Event<span class="token punctuation">,</span>
        queue<span class="token punctuation">:</span> deque<span class="token punctuation">[</span>Message<span class="token punctuation">]</span><span class="token punctuation">,</span>
        uow<span class="token punctuation">:</span> unit_of_work<span class="token punctuation">.</span>AbstractUnitOfWork<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> handler <span class="token keyword">in</span> MessageBus<span class="token punctuation">.</span>EVENT_HANDLERS<span class="token punctuation">[</span><span class="token builtin">type</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">:</span>  <span class="token comment"># 1)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Handling event </span><span class="token interpolation"><span class="token punctuation">{</span>event<span class="token punctuation">}</span></span><span class="token string"> with </span><span class="token interpolation"><span class="token punctuation">{</span>handler<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
            <span class="token keyword">await</span> handler<span class="token punctuation">(</span>event<span class="token punctuation">,</span> uow<span class="token punctuation">)</span>
            queue<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>uow<span class="token punctuation">.</span>collect_new_events<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> ex<span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>exception<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Exception handling </span><span class="token interpolation"><span class="token punctuation">{</span>event<span class="token punctuation">}</span></span><span class="token string">... detail: </span><span class="token interpolation"><span class="token punctuation">{</span>ex<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>                                        <span class="token comment"># 2)</span></code></pre></div>
<ol>
<li>한 이벤트를 여러 핸들러가 처리하도록 위임할 수 있는 디스패처로 이벤트가 처리된다</li>
<li>오류가 생각하면 로그를 남기지만, 오류가 메시지 처리를 방해하지는 못하게 한다</li>
</ol>
<p>커맨드 처리 방안은 아래와 같다:</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">handle_command</span><span class="token punctuation">(</span>
        command<span class="token punctuation">:</span> commands<span class="token punctuation">.</span>Command<span class="token punctuation">,</span>
        queue<span class="token punctuation">:</span> deque<span class="token punctuation">[</span>Message<span class="token punctuation">]</span><span class="token punctuation">,</span>
        uow<span class="token punctuation">:</span> unit_of_work<span class="token punctuation">.</span>AbstractUnitOfWork<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Handling command </span><span class="token interpolation"><span class="token punctuation">{</span>command<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        handler <span class="token operator">=</span> MessageBus<span class="token punctuation">.</span>COMMAND_HANDLERS<span class="token punctuation">[</span><span class="token builtin">type</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">]</span>   <span class="token comment"># 1)</span>
        result <span class="token operator">=</span> <span class="token keyword">await</span> handler<span class="token punctuation">(</span>command<span class="token punctuation">,</span> uow<span class="token punctuation">)</span>
        queue<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>uow<span class="token punctuation">.</span>collect_new_events<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> result                                          <span class="token comment"># 3)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> ex<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>exception<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Exception handling </span><span class="token interpolation"><span class="token punctuation">{</span>command<span class="token punctuation">}</span></span><span class="token string">... detail: </span><span class="token interpolation"><span class="token punctuation">{</span>ex<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        <span class="token keyword">raise</span>                                                  <span class="token comment"># 2)</span></code></pre></div>
<ol>
<li>커맨드 디스패처는 커맨드 하나에 핸들러 하나만을 허용한다(헷갈린다면 10.1 에서 내린 정의를 살펴보자!)</li>
<li>오류가 발생하면 propagate 한다</li>
<li><code class="language-text">return result</code> 구문은 임시방편이다(!) 9.2.3절에서 언급한 내용이다. 이 방법은 API가 사용하기 위한 배치 참조를 돌려주기 위한 값이다. 12장에서 수정할 것이다.</li>
</ol>
<p>메시지 버스를 살펴보자. 두 딕셔너리로 분리한 클래스로 관리한다<sup id="fnref-2"><a href="#fn-2" class="footnote-ref">2</a></sup>. 앞서 살펴보았듯 각 이벤트에는 여러 핸들러가 있을 수 있다. 하지만 각 커맨드에는 핸들러가 하나밖에 없다.</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">MessageBus</span><span class="token punctuation">:</span>
    EVENT_HANDLERS <span class="token operator">=</span> <span class="token punctuation">{</span>                                                 <span class="token comment"># 1)</span>
        events<span class="token punctuation">.</span>OutOfStock<span class="token punctuation">:</span> <span class="token punctuation">[</span>handlers<span class="token punctuation">.</span>send_out_of_stock_notification<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>   <span class="token comment"># type: Dict[Type[events.Event], List[Callable]]</span>
    COMMAND_HANDLERS <span class="token operator">=</span> <span class="token punctuation">{</span>                                               <span class="token comment"># 2)</span>
        commands<span class="token punctuation">.</span>Allocate<span class="token punctuation">:</span> handlers<span class="token punctuation">.</span>allocate<span class="token punctuation">,</span>
        commands<span class="token punctuation">.</span>Deallocate<span class="token punctuation">:</span> handlers<span class="token punctuation">.</span>deallocate<span class="token punctuation">,</span>
        commands<span class="token punctuation">.</span>CreateBatch<span class="token punctuation">:</span> handlers<span class="token punctuation">.</span>add_batch<span class="token punctuation">,</span>
        commands<span class="token punctuation">.</span>ChangeBatchQuantity<span class="token punctuation">:</span> handlers<span class="token punctuation">.</span>change_batch_quantity<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>   <span class="token comment"># type: Dict[Type[commands.Command], Callable]</span></code></pre></div>
<ol>
<li>이벤트 핸들러의 특징을 살펴보자</li>
<li>커맨드 핸들러의 특징도 마찬가지다</li>
</ol>
<h1 id="103-논의-이벤트-커맨드-오류-처리" style="position:relative;"><a href="#103-%EB%85%BC%EC%9D%98-%EC%9D%B4%EB%B2%A4%ED%8A%B8-%EC%BB%A4%EB%A7%A8%EB%93%9C-%EC%98%A4%EB%A5%98-%EC%B2%98%EB%A6%AC" aria-label="103 논의 이벤트 커맨드 오류 처리 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>10.3 논의: 이벤트, 커맨드, 오류 처리</h1>
<p>저자는 여기까지 왔을 때의 불편함이나 개선사항을 아래와 같이 말한다.</p>
<ul>
<li>만약 이벤트 처리에 실패하면 어떻게 처리할 것인가?</li>
<li>시스템이 일관성있는 상태를 유지한다고 어떻게 확신할 수 있나?</li>
<li>현 구조에서는 메시지 유실이 염려된다. 만일 <code class="language-text">MessageBus.handle</code> 에서 이벤트를 절반만 처리하다가 OOM으로 프로세스가 죽으면 메시지가 사라질것이다. 이 경우는 어떻게 해결해야 할까?</li>
</ul>
<p>최악의 경우를 생각해보자. 이벤트 처리에 실패하고 시스템이 일관성을 잃었다. 이로 인해 어떤 오류가 생겼나 살펴보자. 연산 중 일부만 완료된 경우 시스템이 일관성 없는 상태가 될 수 있다.</p>
<p>요컨대 <code class="language-text">DESIRABLE_BEANBAG</code> <sup id="fnref-3"><a href="#fn-3" class="footnote-ref">3</a></sup> 3개를 고객 주문에 할당했지만, 왠진 모르겠으나 현재 재고 감소에 실패했다고 치자. 겉보기엔 재고 세 개가 모두 할당되고 사용 가능한 상태가 되어버린다. 이러면 일관성이 무너진 것이다. 재고 파악을 옳게 못하다가 다른 고객에게 oversell 해버리면?</p>
<p>다행히도 <code class="language-text">Allocate</code> 서비스에서는 조치를 취해놨다. 애그리게이트를 일관성 경계로 동작하게 해놨고, 애그리게이트에 대한 업데이트 성공/실패를 atomic하게 처리하기 위해 UoW를 설계했다.</p>
<p>예를 들자면, 주문에 재고를 할당할 때의 consistency boundary는 <code class="language-text">Product</code> 애그리게이트다. 여기서 과할당을 방지할 수 있다. 특정 주문 라인이 제품에 할당하거나, 그렇지 않으면 아예 할당하지 않는다<sup id="fnref-4"><a href="#fn-4" class="footnote-ref">4</a></sup>.</p>
<p>그리고 프로젝트 정의에 따르면, 두 애그리게이트는 즉각적으로 일관성을 가질 필요가 없다. 어떤 이벤트를 처리하다 실패해서 애그리게이트 하나만 업데이트 된다고 해도, 시스템은 일관성을 갖춘다. 시스템의 제약 조건을 위반하면 안 된다.</p>
<p>이런 예제를 통해 메시지를 커맨드와 이벤트로 분리하는 이유에 대해 다시금 생각할 수 있게 되었다. 사용자가 시스템이 어떤 일을 하길 원한다면 이 요청을 <strong>커맨드</strong>로 표현한다. 커맨드는 한 <strong>애그리게이트</strong>를 변경해야 하고, 전체적으로 성공하거나 모두 실패해야한다. 시스템이 수행하는 다른 재고처리나 후속조치는 <strong>이벤트</strong>로 발생시킨다. 커맨드가 성공하기 위해 이벤트 핸들러가 성공할 필요는 없다.</p>
<p>커맨드가 성공하기 위해 이벤트가 성공하지 않아도 되는 이유를 아래의 다른 예시로 살펴보자.</p>
<h2 id="1031-예제-명품을-파는-전자상거래-사이트-설계" style="position:relative;"><a href="#1031-%EC%98%88%EC%A0%9C-%EB%AA%85%ED%92%88%EC%9D%84-%ED%8C%8C%EB%8A%94-%EC%A0%84%EC%9E%90%EC%83%81%EA%B1%B0%EB%9E%98-%EC%82%AC%EC%9D%B4%ED%8A%B8-%EC%84%A4%EA%B3%84" aria-label="1031 예제 명품을 파는 전자상거래 사이트 설계 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>10.3.1 예제: 명품을 파는 전자상거래 사이트 설계</h2>
<p>어느 사이트에서 많이 팔아주시는 VIP 고객님을 선정하는 기준을 아래와 같이 정리하고 처리하기로 했다 치자.</p>
<ol>
<li>주문 이력이 2개있는</li>
<li>고객이 3번째 주문을 할 때</li>
<li>이 고객을 VIP로 선정한다</li>
<li>처음 VIP로 변경된 고객에게는</li>
<li>축하 메일을 보낸다</li>
</ol>
<p>이걸 애그리게이트 단위로 풀어내면 된다는 뜻이다. 이 애그리게이트를 <code class="language-text">History</code> 라고 하고 예시를 살펴보자. 이 애그리게이트는 주문을 기록하고, 규칙을 만족할 때 도메인 이벤트를 발생시킨다.</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">History</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
            self<span class="token punctuation">,</span>
            customer_id<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>orders<span class="token punctuation">:</span> Set<span class="token punctuation">[</span>HistoryEntry<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>customer_id <span class="token operator">=</span> customer_id

    <span class="token keyword">def</span> <span class="token function">record_order</span><span class="token punctuation">(</span>
            self<span class="token punctuation">,</span>
            order_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
            order_amount<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token comment"># 1)</span>
        entry <span class="token operator">=</span> HistoryEntry<span class="token punctuation">(</span>order_id<span class="token punctuation">,</span> order_amount<span class="token punctuation">)</span>

        <span class="token keyword">if</span> entry <span class="token keyword">in</span> self<span class="token punctuation">.</span>orders<span class="token punctuation">:</span>
            <span class="token keyword">return</span>

        self<span class="token punctuation">.</span>orders<span class="token punctuation">.</span>add<span class="token punctuation">(</span>entry<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>orders<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>events<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
                CustomerBecameVIP<span class="token punctuation">(</span>self<span class="token punctuation">.</span>customer_id<span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
    
<span class="token keyword">def</span> <span class="token function">create_order_from_basket</span><span class="token punctuation">(</span>
        uow<span class="token punctuation">,</span>
        cmd<span class="token punctuation">:</span> CreateOrder<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 2)</span>
    <span class="token keyword">with</span> uow<span class="token punctuation">:</span>
        order <span class="token operator">=</span> Order<span class="token punctuation">.</span>from_basket<span class="token punctuation">(</span>cmd<span class="token punctuation">.</span>customer_id<span class="token punctuation">,</span> cmd<span class="token punctuation">.</span>basket_items<span class="token punctuation">)</span>
        uow<span class="token punctuation">.</span>orders<span class="token punctuation">.</span>add<span class="token punctuation">(</span>order<span class="token punctuation">)</span>
        uow<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># raises OrderCreated</span>

<span class="token keyword">def</span> <span class="token function">update_customer_history</span><span class="token punctuation">(</span>
        uow<span class="token punctuation">,</span>
        event<span class="token punctuation">:</span> OrderCreated<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 3)</span>
    <span class="token keyword">with</span> uow<span class="token punctuation">:</span>
        history <span class="token operator">=</span> uow<span class="token punctuation">.</span>order_history<span class="token punctuation">.</span>get<span class="token punctuation">(</span>event<span class="token punctuation">.</span>customer_id<span class="token punctuation">)</span>
        history<span class="token punctuation">.</span>record_order<span class="token punctuation">(</span>event<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span> event<span class="token punctuation">.</span>order_amount<span class="token punctuation">)</span>
        uow<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># raises CustomerBecameVIP</span>

<span class="token keyword">def</span> <span class="token function">congratulate_vip_customer</span><span class="token punctuation">(</span>
        uow<span class="token punctuation">,</span>
        event<span class="token punctuation">:</span> CustomerBecameVIP<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># 4)</span>
    <span class="token keyword">with</span> uow<span class="token punctuation">:</span>
        customer <span class="token operator">=</span> uow<span class="token punctuation">.</span>customers<span class="token punctuation">.</span>get<span class="token punctuation">(</span>event<span class="token punctuation">.</span>customer_id<span class="token punctuation">)</span>
        email<span class="token punctuation">.</span>send<span class="token punctuation">(</span>
            customer<span class="token punctuation">.</span>email_address<span class="token punctuation">,</span>
            <span class="token string-interpolation"><span class="token string">f'Congratulations </span><span class="token interpolation"><span class="token punctuation">{</span>customer<span class="token punctuation">.</span>first_name<span class="token punctuation">}</span></span><span class="token string">!'</span></span>
        <span class="token punctuation">)</span></code></pre></div>
<ol>
<li><code class="language-text">History</code> 애그리게이트는 고객이 VIP가 되는 규칙을 체크한다. 애그리게이트는 이런 식으로 규칙을 처리하는 좋은 장소임을 캐치하자</li>
<li>첫 핸들러는 고객 주문을 생성하고 <code class="language-text">OrderCreated</code> 라는 도메인 이벤트를 발생시킨다</li>
<li>두 번째 핸들러는 만들어진 주문을 기록하기 위해 <code class="language-text">History</code> 를 업데이트한다</li>
<li>고객에게 VIP가 되었음을 알리는 메일을 전송한다</li>
</ol>
<p>가만보면 이벤트 기반 시스템에서는 오류를 어떻게 처리하는지 볼 수 있다.</p>
<ul>
<li>애그리게이트는 상태를 DB에 <strong>영속화한 이후</strong> 이벤트를 발생시킨다</li>
<li><strong>영속화 이전</strong>에 이벤트 발생 및 변화를 커밋하는건? 그 후에 “동시에” 모든 변화를 커밋하면? 이러면 모든 작업이 완료됐다 할 수 있을텐데 이게 더 낫지 않나?</li>
</ul>
<p>하지만 만일 메일 서버가 과부화라면? 모든 작업이 동시에 끝나야되면 ‘메일 전송’ 작업이 다른 작업의 발목이 될 수도 있다.</p>
<p><code class="language-text">History</code> 애그리게이트에 버그가 있다면? 고객을 VIP로 인식하지 못했다고 해서 고객의 결제처리를 하면 안되는건가?</p>
<p>이런 관심사를 분리하면 실패할 수 있는 요소들이 서로 격리되어 실패하게 할 수 있다. 이 코드에서 성공해야 하는 부분은 주문 생성 커맨드 핸들러 뿐이다. 이 것만이 고객이 신경쓰는 부분이고, 비즈니스 관계자들이 중요하게 생각하는 부분이다.</p>
<p>트랜잭션 경계를 비즈니스 프로세스 시작과 종료에 맞추어 의도적으로 조정한 것인지 살펴보자. 코드에서 쓰는 이름은 비즈니스 관계자들이 쓰는 언어와 일치하며, 핸들러는 자연어로 작성한 판별 기준과 일치한다. 이름과 구조가 일치하면 시스템이 커지고 복잡해질 때, 시스템을 추론하는 과정에서 상당히 도움된다.</p>
<h1 id="104-동기적으로-오류-복구하기" style="position:relative;"><a href="#104-%EB%8F%99%EA%B8%B0%EC%A0%81%EC%9C%BC%EB%A1%9C-%EC%98%A4%EB%A5%98-%EB%B3%B5%EA%B5%AC%ED%95%98%EA%B8%B0" aria-label="104 동기적으로 오류 복구하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>10.4 동기적으로 오류 복구하기</h1>
<p>위에서 살펴본 바와 같이, 이벤트는 이벤트를 발생시킨 커맨드와 독립적으로 실패해도 좋다. 불필요하게 오류가 발생한 경우 오류를 복구시킬 수 있다고 확신하려면 어떻게 해야할까?</p>
<p>가장 먼저 해야할 것은 오류가 언제 일어났는지를 파악하는 것이다. 그것 때문에 오류 발생시점의 로그를 찍는 것이었다. <code class="language-text">handle_event()</code> 로직을 다시 살펴보자.</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">handle_event</span><span class="token punctuation">(</span>
        event<span class="token punctuation">:</span> events<span class="token punctuation">.</span>Event<span class="token punctuation">,</span>
        queue<span class="token punctuation">:</span> deque<span class="token punctuation">[</span>Message<span class="token punctuation">]</span><span class="token punctuation">,</span>
        uow<span class="token punctuation">:</span> unit_of_work<span class="token punctuation">.</span>AbstractUnitOfWork<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> handler <span class="token keyword">in</span> MessageBus<span class="token punctuation">.</span>EVENT_HANDLERS<span class="token punctuation">[</span><span class="token builtin">type</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Handling event </span><span class="token interpolation"><span class="token punctuation">{</span>event<span class="token punctuation">}</span></span><span class="token string"> with </span><span class="token interpolation"><span class="token punctuation">{</span>handler<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
            <span class="token keyword">await</span> handler<span class="token punctuation">(</span>event<span class="token punctuation">,</span> uow<span class="token punctuation">)</span>
            queue<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>uow<span class="token punctuation">.</span>collect_new_events<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> ex<span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>exception<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Exception handling </span><span class="token interpolation"><span class="token punctuation">{</span>event<span class="token punctuation">}</span></span><span class="token string">... detail: </span><span class="token interpolation"><span class="token punctuation">{</span>ex<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span></code></pre></div>
<p>시스템에서 메시지 처리할 때 처음 하는 일은 로그를 찍는 것이다. 위의 <code class="language-text">History</code> 예시를 통해서 다시 참고해보자. <code class="language-text">CustomerBecameVIP</code> 라는 유스케이스의 경우 로그는 아래와 같다:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Handling event CustomerBecameVIP(customer_id=12345) with handler &lt;function congratulate_vip_customer at 0x10ebc9a60></code></pre></div>
<p><code class="language-text">dataclasses</code> 를 써서 저런 식으로 데이터를 요약해서 볼 수 있다. 객체를 다시 만들기 위해 이 출력을 복사해 파이썬 shell에 복붙도 할 수 있다.</p>
<p>오류가 발생하면 로그에 저장된 데이터를 사용해 문제를 유닛테스트로 재현하거나 시스템에서 메시지를 다시 실행할 수 있다.</p>
<p>이벤트를 다시 처리하기 전에 버그를 수정해야 한다면 수동 재실행이 잘 작동한다. 하지만 시스템은 어쨌거나 백그라운드에서 <strong>일시적인 실패가 일정 수준은 항상 존재</strong>할 것이다. 이런 실패에는 네트워크의 일시적 문제, DB의 데드락, 배치로 인해 발생하는 일시적 서비스 중단 등이 그것이다.</p>
<p>이런 경우에는 재시도를 하여 깔끔하게 복구할 수 있다. ‘깔끔하게’ 라는 뜻은 ‘한 번 만에 안 되면 기하급수적으로 증가하는 백오프 기간(<em>exponentially increasing back-off period</em>) 후에 재시도 한다’를 의미한다.</p>
<p>동기적으로 재시도하는 코드의 예시를 보자:</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> tenacity <span class="token keyword">import</span> <span class="token punctuation">(</span>
    Retrying<span class="token punctuation">,</span>
    RetryError<span class="token punctuation">,</span>
    stop_after_attempt<span class="token punctuation">,</span>
    wait_exponential<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token comment">#(1)</span>

<span class="token keyword">def</span> <span class="token function">handle_event</span><span class="token punctuation">(</span>
    event<span class="token punctuation">:</span> events<span class="token punctuation">.</span>Event<span class="token punctuation">,</span>
    queue<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Message<span class="token punctuation">]</span><span class="token punctuation">,</span>
    uow<span class="token punctuation">:</span> unit_of_work<span class="token punctuation">.</span>AbstractUnitOfWork<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> handler <span class="token keyword">in</span> EVENT_HANDLERS<span class="token punctuation">[</span><span class="token builtin">type</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> attempt <span class="token keyword">in</span> Retrying<span class="token punctuation">(</span>  <span class="token comment">#(2)</span>
                stop<span class="token operator">=</span>stop_after_attempt<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                wait<span class="token operator">=</span>wait_exponential<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">:</span>

                <span class="token keyword">with</span> attempt<span class="token punctuation">:</span>
                    logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">"handling event %s with handler %s"</span><span class="token punctuation">,</span> event<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
                    handler<span class="token punctuation">(</span>event<span class="token punctuation">,</span> uow<span class="token operator">=</span>uow<span class="token punctuation">)</span>
                    queue<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>uow<span class="token punctuation">.</span>collect_new_events<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> RetryError <span class="token keyword">as</span> retry_failure<span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span>
                <span class="token string">"Failed to handle event %s times, giving up!"</span><span class="token punctuation">,</span>
                retry_failure<span class="token punctuation">.</span>last_attempt<span class="token punctuation">.</span>attempt_number
            <span class="token punctuation">)</span>
            <span class="token keyword">continue</span></code></pre></div>
<ol>
<li><a href="https://github.com/jd/tenacity" target="_blank" rel="nofollow noopener noreferrer">Tenacity</a>는 파이썬에서 재시도와 관련한 패턴을 구현한 라이브러리다</li>
<li>여기서는 메시지버스가 <code class="language-text">3</code>번을 기하급수적으로 증가하는 백오프 기간을 두고 재시도한다</li>
</ol>
<p>실패할 수도 있는 연산을 재시도하는 것은 시스템의 회복 탄력성(<em>resilience</em>)을 향상시키는 최선의 방안일 것이다. 최소한 이렇게라도 해야 작업이 반쯤 끝난 상태로 남지 않게 한다.</p>
<blockquote>
<p>‼️ <strong>CAUTION</strong> ‼️</p>
</blockquote>
<p><code class="language-text">tenacity</code> 를 쓰는 것과 별개로, 어느 시점에서는 메시지를 처리하려는 시도를 <em>포기</em> 해야한다.
분산 메시지를 사용해서 <em>반드시</em> 신뢰할 수 있는 시스템을 만드는 것은 매우 힘든 일이다. 그 부분은 에필로그에서 다시 볼 것이다</p>
<blockquote>
</blockquote>
<p>여기서는 <code class="language-text">tenacity</code>를 사용한 비동기 코드의 작업방안에 대해 살펴본다:</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"></code></pre></div>
<h1 id="105-마치며" style="position:relative;"><a href="#105-%EB%A7%88%EC%B9%98%EB%A9%B0" aria-label="105 마치며 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>10.5 마치며</h1>
<p>커맨드, 이벤트 개념을 알아봤다. 시스템이 응답할 수 있는 요청에 이름을 붙이고 자체적인 데이터 구조를 제공하여 명시하는 일에 대해 알게 되었다. 이번 장에서 살펴본 이벤트, 커맨드, 메시지 버스를 통한 처리를 커맨드 핸들러(<em>command handler</em>) 라고 부르기도 한다.</p>
<p>아래 표는 커맨드, 이벤트 분리를 적용하기 전 살펴봐야 할 트레이드오프다:</p>
<table>
<thead>
<tr>
<th>장점</th>
<th>단점</th>
</tr>
</thead>
<tbody>
<tr>
<td>커맨드와 이벤트를 다른 방식으로 처리하면, 어떤 부분이 반드시 성공해야 하는지, 나중에 정리해도 되는지를 구별하는데 도움이 된다</td>
<td>커맨드와 이벤트의 의미적 차이가 사람마다 다를 수 있다. 둘 사이의 차이를 구성원 모두가 동의하는 데 시간을 써야할 수도 있다</td>
</tr>
<tr>
<td>CreateBatch 는 BatchCreated 보다는 의도가 훨씬 명시적이다</td>
<td>실패를 명확히 구별한다. 프로그램이 깨질 수 있다는 사실을 알고, 실패를 더 작고 격리가능한 단위로 나누기로 결정한다. 이를 통해 시스템 추론이 더 어려워지고 모니터링의 중요성이 대두된다</td>
</tr>
</tbody>
</table>
<p>11장에서는 이벤트를 통합 패턴으로 쓰는 법에 대해 알아보자.</p>
<hr>
<div class="footnotes">
<hr>
<ol>
<li id="fn-1"><em>actor</em> 라고 써져있다. 그런데 DDD에서 쓰는 그 Actor 같기도 해서, 음차해서 쓰는 편이 나을 것으로 판단했다.<a href="#fnref-1" class="footnote-backref">↩</a></li>
<li id="fn-2">13장에서 개조할 클래스 형식의 메시지 버스에 대한 일부분이다. 13장 코드를 미리 살펴보면 아예 핸들용 클래스로 따로 떨어져있고, 시스템 구동 시의 부트스트랩에서 의존성을 모두 깔끔하게 처리한다. 지금 한큐에 이해하긴 힘들고, 한번에 느리게 하기보단 차라리 못생긴 모습을 들고가서 추후에 바꾸려고 한다. 이런 방안이야말로 어쨌거나 더 빠르게 문제를 해결하는 방법이니까…<a href="#fnref-2" class="footnote-backref">↩</a></li>
<li id="fn-3">대충 이런 상품이 있다고 생각해주세요<a href="#fnref-3" class="footnote-backref">↩</a></li>
<li id="fn-4"><code class="language-text">Product.allocate()</code> 은 내부적으로 <code class="language-text">Batch.can_allocate()</code> 로직을 거치기 때문<a href="#fnref-4" class="footnote-backref">↩</a></li>
</ol>
</div></div></div></div><div class="Post-module--footer--f8705"><div class="Meta-module--meta--dae0a"><p class="Meta-module--date--4d30d">Published<!-- --> <!-- -->May 7, 2023</p></div><div class="Tags-module--tags--18589"><ul class="Tags-module--list--82ae6"><li class="Tags-module--item--52015"><a class="Button-module--button--b1113" href="/tag/ddd/">ddd</a></li><li class="Tags-module--item--52015"><a class="Button-module--button--b1113" href="/tag/books/">books</a></li><li class="Tags-module--item--52015"><a class="Button-module--button--b1113" href="/tag/backend/">backend</a></li><li class="Tags-module--item--52015"><a class="Button-module--button--b1113" href="/tag/python/">python</a></li></ul></div><div class="Author-module--author--1c58d"><p class="Non scholæ sed vitæ discimus.">Non scholæ sed vitæ discimus.</p><p class="Author-module--bio--08950">his/him</p></div></div><div class="Post-module--comments--d3b99"><div></div></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/books/cosmic-python/2023-05-07-pt02-ch10";window.___webpackCompilationHash="3651d46ab0d7db62e236";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-7055f09f7466fba7a9ff.js"],"app":["/app-d86c750f96c572bb8092.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-0c915c7b1bdb5eac4fdf.js"],"component---src-templates-categories-template-categories-template-tsx":["/component---src-templates-categories-template-categories-template-tsx-e2d2add397e32e3517ca.js"],"component---src-templates-category-template-category-template-tsx":["/component---src-templates-category-template-category-template-tsx-078f2adfba160a34229f.js"],"component---src-templates-index-template-index-template-tsx":["/component---src-templates-index-template-index-template-tsx-83380c7954c9f6621026.js"],"component---src-templates-not-found-template-not-found-template-tsx":["/component---src-templates-not-found-template-not-found-template-tsx-56fe4d3b015459d56c99.js"],"component---src-templates-page-template-page-template-tsx":["/component---src-templates-page-template-page-template-tsx-c6c21d7369a9356db3a1.js"],"component---src-templates-post-template-post-template-tsx":["/component---src-templates-post-template-post-template-tsx-119cd0258cb38628d01f.js"],"component---src-templates-tag-template-tag-template-tsx":["/component---src-templates-tag-template-tag-template-tsx-8d0b3090e775aa3c4584.js"],"component---src-templates-tags-template-tags-template-tsx":["/component---src-templates-tags-template-tags-template-tsx-30027e87af7d042f3afb.js"]};/*]]>*/</script><script src="/polyfill-7055f09f7466fba7a9ff.js" nomodule=""></script><script src="/app-d86c750f96c572bb8092.js" async=""></script><script src="/framework-481a1b6416c14416b2fb.js" async=""></script><script src="/webpack-runtime-de5a94456c9c32f6cdb9.js" async=""></script></body></html>